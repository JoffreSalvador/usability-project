<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listening Game - EnglishMaster</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css" />
    <link rel="stylesheet" href="../assets/css/games.css" />
    <link rel="stylesheet" href="../assets/css/listening-game.css" />
    <style>
        /* Audio Selection Screen Styles - Carousel Style */
        .audio-selection-screen {
            background: #e8fff0;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .audio-selection-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .audio-selection-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .audio-selection-title {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .audio-selection-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 2rem;
        }

        /* Carousel Styles */
        .audio-carousel-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .audio-carousel {
            display: flex;
            transition: transform 0.5s ease;
            gap: 2rem;
        }

        .audio-card {
            min-width: 350px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: scale(0.9);
            opacity: 0.7;
        }

        .audio-card.center {
            transform: scale(1);
            opacity: 1;
            border-color: #00a86b;
            box-shadow: 0 12px 35px rgba(0,168,107,0.2);
        }

        .audio-card:hover {
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .audio-card.center:hover {
            transform: scale(1.02);
        }
        
        .audio-card-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        
        .audio-card-image.advice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .audio-card-image.llamas {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .audio-card-image.weekend {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .audio-card-emoji {
            font-size: 4rem;
            position: relative;
            z-index: 2;
        }
        
        .audio-card-content {
            padding: 2rem;
        }
        
        .audio-card-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 0.8rem;
            color: #333;
        }
        
        .audio-card-description {
            color: #666;
            margin-bottom: 1.2rem;
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .audio-card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .difficulty-tag {
            background: #00a86b;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .category-tag {
            color: #666;
            font-size: 0.9rem;
        }

        .carousel-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .carousel-btn {
            background: white;
            border: 2px solid #00a86b;
            color: #00a86b;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .carousel-btn:hover:not(:disabled) {
            background: #00a86b;
            color: white;
            transform: scale(1.1);
        }

        .carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .carousel-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-indicator.active {
            background: #00a86b;
            transform: scale(1.2);
        }

        .select-audio-btn {
            background: #00a86b;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,168,107,0.3);
        }

        .select-audio-btn:hover {
            background: #008f5a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,168,107,0.4);
        }

        /* Audio Selection Modal */
        .audio-selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .audio-selection-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .audio-selection-modal.show .modal-content {
            transform: scale(1);
        }

        .modal-audio-info {
            margin-bottom: 2rem;
        }

        .modal-audio-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00a86b;
            margin-bottom: 0.5rem;
        }

        .modal-audio-description {
            color: #666;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-btn.primary {
            background: #00a86b;
            color: white;
        }

        .modal-btn.secondary {
            background: white;
            color: #00a86b;
            border: 2px solid #00a86b;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .modal-btn.primary:hover {
            background: #008f5a;
        }

        .modal-btn.secondary:hover {
            background: #f0fff4;
        }

        /* Answer validation message */
        .answer-required-message {
            background: #ff4757;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .answer-required-message.show {
            display: block;
        }
        
        /* Updated audio player with navigation */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .audio-controls-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .audio-progress-section {
            flex: 1;
            min-width: 200px;
        }
        
        .audio-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
        }
        
        .audio-progress-fill {
            height: 100%;
            background: #00a86b;
            border-radius: 10px;
            transition: width 0.2s;
            width: 0%;
        }
        
        .audio-progress-bar:hover .audio-progress-fill {
            background: #008f5a;
        }
        
        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Enhanced audio controls */
        .audio-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: white;
            border: 2px solid #00a86b;
            color: #00a86b;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .control-btn:hover {
            background: #00a86b;
            color: white;
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: #00a86b;
            color: white;
        }

        /* Enhanced feedback section */
        .feedback-result {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border-left: 5px solid #ddd;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            animation: feedbackSlideIn 0.5s ease-out;
        }

        /* Spacing for feedback section */
.feedback-section {
    margin-top: 2rem;
}

.feedback-content {
    margin-bottom: 2rem;
}

        .feedback-result.correct {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left-color: #28a745;
            color: #155724;
        }

        .feedback-result.incorrect {
            background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
            border-left-color: #dc3545;
            color: #721c24;
        }

        .feedback-icon {
            font-size: 3rem;
            min-width: 60px;
            text-align: center;
            animation: feedbackPulse 0.6s ease-out;
        }

        .feedback-text h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .feedback-text p {
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .score-update {
            background: #00a86b;
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,168,107,0.3);
            animation: scoreUpdate 0.6s ease-out;
        }

        @keyframes feedbackSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes feedbackPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes scoreUpdate {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Enhanced option selection feedback */
        .option {
            transition: all 0.3s ease;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .option.selected {
            background: rgba(0,168,107,0.1);
            border-color: #00a86b;
            transform: translateX(5px);
        }

        .option.correct {
            background: rgba(40,167,69,0.1);
            border-color: #28a745;
            animation: correctAnswer 0.6s ease-out;
        }

        .option.incorrect {
            background: rgba(220,53,69,0.1);
            border-color: #dc3545;
            animation: incorrectAnswer 0.6s ease-out;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); background: rgba(40,167,69,0.2); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .audio-card {
                min-width: 300px;
            }
            
            .audio-card-image {
                height: 150px;
            }
            
            .audio-card-emoji {
                font-size: 3rem;
            }
            
            .audio-player {
                justify-content: center;
            }
            
            .audio-progress-section {
                order: 3;
                width: 100%;
            }
            
            .audio-selection-title {
                font-size: 1.8rem;
            }

            .modal-content {
                padding: 2rem;
                margin: 1rem;
            }

            .modal-actions {
                flex-direction: column;
            }

            .feedback-result {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
        }
        
        /* Accessibility improvements */
        .audio-card:focus {
            outline: 3px solid #00a86b;
            outline-offset: 2px;
        }
        
        @media (prefers-reduced-motion: reduce) {
            .audio-card,
            .control-btn,
            .audio-carousel,
            .feedback-result {
                transition: none;
                animation: none;
            }
            
            .audio-card:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="left">
                <a href="dashboard.html" class="logo">
                    <img src="../assets/img/logo.png" alt="EnglishMaster Logo" />
                </a>
            </div>
            <div class="center">
                <nav aria-label="Main Navigation">
                    <ul class="nav-list">
                        <li><a href="features.html">Features</a></li>
                        <li><a href="games.html" class="active">Games</a></li>
                        <li><a href="about.html">About</a></li>
                    </ul>
                </nav>
            </div>
            <div class="right auth-buttons" id="authArea" style="opacity: 0; transition: opacity 0.3s ease-in-out;">
                <a href="login.html" class="btn-outline" id="signInBtn">Sign In</a>
                <a href="register.html" class="btn-filled" id="getStartedBtn">Get Started</a>

                <div id="userInfo" style="display: none;">
                    <span id="userName" class="text-lg font-semibold mr-2"></span>
                    <button id="logoutBtn" class="btn-outline">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="listening-game-main">
        <!-- Tutorial Screens -->
        <div id="tutorial-screen" class="screen active">
            <div class="tutorial-container">
                <div class="tutorial-header">
                    <div class="game-badge">
                        <div class="game-icon-large">üéµ</div>
                        <span>Listening Game</span>
                    </div>
                    <button class="skip-tutorial-btn" onclick="skipTutorial()">Skip Tutorial</button>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-step active" data-step="1">
                        <div class="tutorial-icon">üéµ</div>
                        <h2>Welcome to Listening Game!</h2>
                        <p>Master your English listening skills with fun interactive audio stories!</p>
                        <div class="tutorial-dots">
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                        <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                    </div>

                    <div class="tutorial-step" data-step="2">
                        <div class="tutorial-icon">üéß</div>
                        <h2>Ready to Expand Your Listening Skills?</h2>
                        <p>This game will test your English listening comprehension through interactive audio stories</p>
                        <div class="tutorial-benefits">
                            <div class="benefit-item">‚Ä¢ New English conversation contexts</div>
                            <div class="benefit-item">‚Ä¢ Audio comprehension improvement</div>
                            <div class="benefit-item">‚Ä¢ Context and story exercises</div>
                            <div class="benefit-item">‚Ä¢ Speaking and pronunciation</div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                        </div>
                    </div>

                    <div class="tutorial-step" data-step="3">
                        <div class="tutorial-icon">üèÜ</div>
                        <h2>Scoring System</h2>
                        <p>Understand how points are awarded and track your progress.</p>
                        <div class="scoring-system">
                            <div class="score-item correct">
                                <div class="score-icon">‚úÖ</div>
                                <div class="score-details">
                                    <h4>Correct Answer</h4>
                                    <p>20% score for each correct response</p>
                                </div>
                            </div>
                            <div class="score-item perfect">
                                <div class="score-icon">üéØ</div>
                                <div class="score-details">
                                    <h4>Perfect Score</h4>
                                    <p>Answer all 5 questions correctly for 100%</p>
                                </div>
                            </div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                        </div>
                    </div>

                    <div class="tutorial-step" data-step="4">
                        <div class="tutorial-icon">üí°</div>
                        <h2>Tips for Success</h2>
                        <p>Learn strategies to improve your vocabulary learning experience.</p>
                        <div class="tips-list">
                            <div class="tip-item">
                                <span class="tip-icon">üéß</span>
                                <div class="tip-content">
                                    <h4>Listen Carefully</h4>
                                    <p>Take your time to understand the context before answering</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">üìñ</span>
                                <div class="tip-content">
                                    <h4>Learn from Audio</h4>
                                    <p>Use transcripts when needed to improve comprehension</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">üîÑ</span>
                                <div class="tip-content">
                                    <h4>Practice Regularly</h4>
                                    <p>Consistent listening is key to improving English skills</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">üéØ</span>
                                <div class="tip-content">
                                    <h4>Use Context Clues</h4>
                                    <p>Pay attention to tone, emotions, and background sounds</p>
                                </div>
                            </div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                        </div>
                    </div>

                    <div class="tutorial-step" data-step="5">
                        <div class="tutorial-icon">‚úÖ</div>
                        <h2>Ready to Start!</h2>
                        <p>You're all set to begin your listening learning adventure!</p>
                        <div class="ready-message">
                            <div class="ready-icon">‚úÖ</div>
                            <h3>You're Ready to Play!</h3>
                            <p>Start with beginner level stories and work your way up. Remember, learning is a journey!</p>
                        </div>
                        <div class="game-features">
                            <h4>Game Features:</h4>
                            <div class="feature-list">
                                <div class="feature-item">‚úÖ 5 audio stories per round</div>
                                <div class="feature-item">‚úÖ Multiple difficulty levels</div>
                                <div class="feature-item">‚úÖ Instant feedback</div>
                                <div class="feature-item">‚úÖ Progress tracking</div>
                            </div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled start-playing" onclick="showRules()">Start Playing Now! ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <div class="rules-container">
                <div class="rules-header">
                    <button class="back-btn" onclick="showTutorial()">‚Üê Back to Tutorial</button>
                    <div class="game-badge">
                        <div class="game-icon-large">üéµ</div>
                        <span>Listening Game</span>
                    </div>
                </div>
                
                <div class="rules-content">
                    <h2>Audio Challenge</h2>
                    <p class="rules-subtitle">Test your English listening comprehension with 5 engaging audio stories</p>
                    
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-number">5</div>
                            <div class="stat-label">Stories to Complete</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">‚àû</div>
                            <div class="stat-label">No Time Limit</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">100%</div>
                            <div class="stat-label">Max Score</div>
                        </div>
                    </div>

                    <div class="game-rules">
                        <h3>Game Rules:</h3>
                        <ul class="rules-list">
                            <li>‚Ä¢ Listen to each audio story segment carefully</li>
                            <li>‚Ä¢ Answer questions about what you heard</li>
                            <li>‚Ä¢ Take your time - there's no time limit per question</li>
                            <li>‚Ä¢ Each correct answer contributes 20% to your final score</li>
                            <li>‚Ä¢ Perfect score: Answer all 5 questions correctly for 100%</li>
                        </ul>
                    </div>

                    <button class="btn-filled start-game-btn" onclick="showAudioSelection()">Select Audio ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Audio Selection Screen - Carousel Style -->
        <div id="audio-selection-screen" class="screen">
            <div class="audio-selection-screen">
                <div class="audio-selection-container">
                    <div class="audio-selection-header">
                        <button class="back-btn" onclick="showRules()" style="position: absolute; top: 2rem; left: 2rem;">‚Üê Back to Rules</button>
                        <h1 class="audio-selection-title">Choose Your Audio Story</h1>
                        <p class="audio-selection-subtitle">Navigate through audio stories and select the one you want to play</p>
                    </div>

                    <div class="audio-carousel-container">
                        <div class="audio-carousel" id="audio-carousel">
                            <div class="audio-card center" data-audio="advice">
                                <div class="audio-card-image advice">
                                    <div class="audio-card-emoji">üí°</div>
                                </div>
                                <div class="audio-card-content">
                                    <h3 class="audio-card-title">B1 Advice for Exams</h3>
                                    <p class="audio-card-description">Learn valuable study tips and exam strategies from experienced students and teachers.</p>
                                    <div class="audio-card-info">
                                        <span class="difficulty-tag">Intermediate</span>
                                        <span class="category-tag">üìö Educational</span>
                                    </div>
                                </div>
                            </div>

                            <div class="audio-card" data-audio="llamas">
                                <div class="audio-card-image llamas">
                                    <div class="audio-card-emoji">ü¶ô</div>
                                </div>
                                <div class="audio-card-content">
                                    <h3 class="audio-card-title">B1 Llamas</h3>
                                    <p class="audio-card-description">Discover fascinating facts about llamas and their role in South American culture.</p>
                                    <div class="audio-card-info">
                                        <span class="difficulty-tag">Intermediate</span>
                                        <span class="category-tag">üåç Culture & Nature</span>
                                    </div>
                                </div>
                            </div>

                            <div class="audio-card" data-audio="weekend">
                                <div class="audio-card-image weekend">
                                    <div class="audio-card-emoji">üåü</div>
                                </div>
                                <div class="audio-card-content">
                                    <h3 class="audio-card-title">B1 The Weekend</h3>
                                    <p class="audio-card-description">Join a conversation about weekend plans, activities, and memorable experiences.</p>
                                    <div class="audio-card-info">
                                        <span class="difficulty-tag">Intermediate</span>
                                        <span class="category-tag">üí¨ Conversation</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="carousel-controls">
                            <button class="carousel-btn" id="prev-btn" onclick="previousAudio()">‚Äπ</button>
                            <div class="carousel-indicators">
                                <div class="carousel-indicator active" data-index="0"></div>
                                <div class="carousel-indicator" data-index="1"></div>
                                <div class="carousel-indicator" data-index="2"></div>
                            </div>
                            <button class="carousel-btn" id="next-btn" onclick="nextAudio()">‚Ä∫</button>
                        </div>

                        <div style="text-align: center;">
                            <button class="select-audio-btn" onclick="openAudioModal()">Select This Audio</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Selection Modal -->
        <div class="audio-selection-modal" id="audio-selection-modal">
            <div class="modal-content">
                <div class="modal-audio-info">
                    <h3 class="modal-audio-title" id="modal-audio-title">B1 Advice for Exams</h3>
                    <p class="modal-audio-description" id="modal-audio-description">Learn valuable study tips and exam strategies from experienced students and teachers.</p>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn primary" onclick="startGameFromModal()">Start Game</button>
                    <button class="modal-btn secondary" onclick="closeAudioModal()">Choose Other Audio</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-container">
                <div class="game-header">
                    <div class="game-info">
                        <div class="game-badge-small">
                            <div class="game-icon-small">üéµ</div>
                            <span>Listening Game</span>
                        </div>
                        <div class="game-progress">
                            <span id="current-story">Question 1</span> of <span id="total-stories">5</span>
                        </div>
                    </div>
                    <div class="game-stats-header">
                        <div class="score-display">Score: <span id="current-score">0%</span></div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div class="story-content">
                    <div class="story-header">
                        <h2 id="story-title">A Morning at the Coffee Shop</h2>
                        <div class="difficulty-badge" id="difficulty-badge">Intermediate</div>
                    </div>

                    <!-- Enhanced Audio Player Section -->
                    <div class="audio-section">
                        <div class="audio-player">
                            <div class="audio-controls-left">
                                <button class="audio-btn play-btn" id="play-btn" aria-label="Play audio">
                                    <span class="play-icon">‚ñ∂Ô∏è</span>
                                </button>
                                <button class="audio-btn pause-btn" id="pause-btn" style="display: none;" aria-label="Pause audio">
                                    <span class="pause-icon">‚è∏Ô∏è</span>
                                </button>
                                <button class="audio-btn restart-btn" id="restart-btn" aria-label="Restart audio">
                                    <span class="restart-icon">‚èÆÔ∏è</span>
                                </button>
                                <button class="audio-btn volume-btn" id="volume-btn" aria-label="Toggle volume">üîä</button>
                            </div>
                            
                            <div class="audio-progress-section">
                                <div class="audio-progress-bar" id="audio-progress-bar" role="slider" aria-label="Audio progress" tabindex="0">
                                    <div class="audio-progress-fill" id="audio-progress-fill"></div>
                                </div>
                                <div class="audio-time">
                                    <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                                </div>
                            </div>
                        </div>
                        <div class="audio-controls">
                            <button class="control-btn" id="speed-btn">Speed: 1x</button>
                            <button class="control-btn" id="transcript-btn">Show Transcript</button>
                        </div>
                    </div>

                    <!-- Question Section -->
                    <div class="question-section" id="question-section">
                        <!-- Answer required message -->
                        <div class="answer-required-message" id="answer-required-message">
                            ‚ö†Ô∏è Please select an answer before submitting
                        </div>

                        <h3 class="question-text" id="question-text">
                            What did Sarah order at the coffee shop?
                        </h3>
                        
                        <div class="options-container" id="options-container">
                            <div class="option" data-option="0">
                                <input type="radio" name="answer" id="option-0" value="0">
                                <label for="option-0">A large cappuccino with extra foam</label>
                            </div>
                            <div class="option" data-option="1">
                                <input type="radio" name="answer" id="option-1" value="1">
                                <label for="option-1">Her usual morning coffee</label>
                            </div>
                            <div class="option" data-option="2">
                                <input type="radio" name="answer" id="option-2" value="2">
                                <label for="option-2">The new seasonal pumpkin drink</label>
                            </div>
                            <div class="option" data-option="3">
                                <input type="radio" name="answer" id="option-3" value="3">
                                <label for="option-3">A simple black coffee</label>
                            </div>
                        </div>

                        <button class="btn-filled submit-btn" id="submit-btn" onclick="submitAnswer()">Submit Answer</button>
                    </div>

                    <!-- Feedback Section -->
                    <div class="feedback-section" id="feedback-section" style="display: none;">
                        <div class="feedback-content" id="feedback-content">
                            <!-- Feedback will be inserted here -->
                        </div>
                        <button class="btn-filled next-btn" id="next-btn" onclick="nextStory()">Next Question ‚Üí</button>
                    </div>
                </div>

                <!-- Transcript Modal -->
                <div class="transcript-modal" id="transcript-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                    <div class="transcript-content" style="background: white; max-width: 600px; width: 90%; max-height: 80vh; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div class="transcript-header" style="background: #00a86b; color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.3rem;">Audio Transcript</h3>
                            <button class="close-transcript" onclick="closeTranscript()" style="background: none; border: none; color: white; font-size: 2rem; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.3s;">√ó</button>
                        </div>
                        <div class="transcript-text" id="transcript-text" style="padding: 2rem; line-height: 1.6; font-size: 1rem; max-height: 400px; overflow-y: auto;">
                            Loading transcript...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Complete Screen -->
        <div id="complete-screen" class="screen">
            <div class="complete-container">
                <div class="complete-header">
                    <button class="back-btn" onclick="backToAudioSelection()">‚Üê Select New Audio</button>
                    <div class="game-badge">
                        <div class="game-icon-large">üéµ</div>
                        <span>Game Complete</span>
                    </div>
                </div>

                <div class="complete-content">
                    <div class="achievement-icon">üéØ</div>
                    <h2>Keep Learning!</h2>
                    <p class="complete-subtitle">You completed the audio challenge!</p>

                    <div class="final-stats">
                        <div class="final-stat">
                            <div class="stat-number" id="final-score">80%</div>
                            <div class="stat-label">Final Score</div>
                        </div>
                        <div class="final-stat">
                            <div class="stat-number" id="final-accuracy">80%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="final-stat">
                            <div class="stat-number" id="final-correct">4/5</div>
                            <div class="stat-label">Correct</div>
                        </div>
                    </div>

                    <div class="performance-summary">
                        <h3>Performance Summary</h3>
                        <div class="performance-list" id="performance-list">
                            <!-- Performance items will be inserted here -->
                        </div>
                    </div>

                    <div class="complete-actions">
                        <button class="btn-outline play-again-btn" onclick="playAgain()">
                            üîÑ Play Again
                        </button>
                        <button class="btn-filled dashboard-btn" onclick="goToDashboard()">
                            üìä Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Audio elements for previews -->
    <audio id="preview-audio" style="display: none;"></audio>
    <audio id="game-audio" style="display: none;"></audio>

    <!-- Incluir los scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <!-- Tu script de autenticaci√≥n UI -->
    <script src="../utils/auth-ui.js"></script>

    <!-- Script espec√≠fico del juego -->
    <script>
        // Variables globales
        let selectedAudioType = 'advice'; // Default selection
        let currentAudio = null;
        let previewAudio = document.getElementById('preview-audio');
        let gameAudio = document.getElementById('game-audio');
        let currentCarouselIndex = 0;
        const audioTypes = ['advice', 'llamas', 'weekend'];

        // Carousel functions
        function updateCarousel() {
            const carousel = document.getElementById('audio-carousel');
            const cards = carousel.querySelectorAll('.audio-card');
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Remove center class from all cards
            cards.forEach(card => card.classList.remove('center'));
            indicators.forEach(indicator => indicator.classList.remove('active'));
            
            // Add center class to current card
            cards[currentCarouselIndex].classList.add('center');
            indicators[currentCarouselIndex].classList.add('active');
            
            // Update selected audio type
            selectedAudioType = audioTypes[currentCarouselIndex];
            
            // Transform carousel
            const offset = -currentCarouselIndex * (350 + 32); // card width + gap
            carousel.style.transform = `translateX(calc(50% - 175px + ${offset}px))`;
            
            // Update button states
            document.getElementById('prev-btn').disabled = currentCarouselIndex === 0;
            document.getElementById('next-btn').disabled = currentCarouselIndex === audioTypes.length - 1;
        }

        function nextAudio() {
            if (currentCarouselIndex < audioTypes.length - 1) {
                currentCarouselIndex++;
                updateCarousel();
            }
        }

        function previousAudio() {
            if (currentCarouselIndex > 0) {
                currentCarouselIndex--;
                updateCarousel();
            }
        }

        // Modal functions
        function openAudioModal() {
            const audioInfo = getAudioInfo(selectedAudioType);
            document.getElementById('modal-audio-title').textContent = audioInfo.title;
            document.getElementById('modal-audio-description').textContent = audioInfo.description;
            document.getElementById('audio-selection-modal').classList.add('show');
        }

        function closeAudioModal() {
            document.getElementById('audio-selection-modal').classList.remove('show');
        }

        function startGameFromModal() {
            closeAudioModal();
            startGame();
        }

        function getAudioInfo(audioType) {
            const audioData = {
                advice: {
                    title: 'B1 Advice for Exams',
                    description: 'Learn valuable study tips and exam strategies from experienced students and teachers.',
                    file: '../data/audio/B1_Advice_for_exams.mp3',
                    image: '../data/img/Advice_for_exams.jpg',
                    transcript: `Sarah: Hi Mark! I heard you aced your final exams last semester. Do you have any advice for someone who's really nervous about upcoming tests?

Mark: Oh, thanks Sarah! Yeah, I was pretty stressed at first too. But I found that starting early really makes a huge difference. Don't wait until the last week to begin studying.

Sarah: That makes sense. How early do you think I should start?

Mark: I'd say at least three weeks before your first exam. That gives you time to review everything properly and not feel rushed. Also, make a study schedule and stick to it.

Sarah: A schedule sounds good. What about the actual studying methods? I usually just read my notes over and over, but it doesn't seem to help much.

Mark: Reading is passive. Try active learning instead. Make flashcards, explain concepts out loud to yourself, or teach the material to a friend. When you have to explain something, you really understand if you know it or not.

Sarah: That's really helpful! I never thought about teaching others. Any other tips?

Mark: Definitely take care of your health. Get enough sleep, eat well, and take short breaks while studying. Your brain needs rest to process information properly. And don't forget to stay hydrated!

Sarah: Thanks Mark! This is all really useful advice. I feel much more confident about my exams now.`
                },
                llamas: {
                    title: 'B1 Llamas',
                    description: 'Discover fascinating facts about llamas and their role in South American culture.',
                    file: '../data/audio/B1_llamas.mp3',
                    image: '../data/img/llamas.png',
                    transcript: `Welcome to our nature documentary about llamas, one of South America's most fascinating animals.

Llamas are domesticated animals that originally come from the high mountains of South America, particularly in countries like Peru, Bolivia, and Ecuador. They belong to the camel family, but unlike their desert cousins, llamas are perfectly adapted to life in the high altitudes of the Andes Mountains.

For thousands of years, the indigenous people of South America have used llamas for many purposes. These gentle animals are excellent for carrying heavy loads across mountain paths where vehicles cannot go. A single llama can carry up to 30 kilograms of supplies, making them invaluable pack animals for mountain communities.

Llamas are also valued for their soft, warm wool. Their thick coats protect them from the cold mountain weather, and people use this wool to make clothing, blankets, and other textiles. Llama wool is known for being lightweight yet very warm.

One interesting thing about llamas is how they communicate. They make soft humming sounds to talk to each other, and they use body language extensively. When they're angry or feel threatened, llamas are famous for spitting! This might seem funny, but it's actually an effective way for them to defend themselves.

Today, llamas are not only working animals but also popular in many countries around the world for their gentle nature and unique appearance.`
                },
                weekend: {
                    title: 'B1 The Weekend',
                    description: 'Join a conversation about weekend plans, activities, and memorable experiences.',
                    file: '../data/audio/B1_the_weekend.mp3',
                    image: '../data/img/the_weekend.jpg',
                    transcript: `Emma: Hey Jake! It's Friday afternoon - do you have any exciting plans for the weekend?

Jake: Hi Emma! Yeah, I'm really looking forward to it. Tomorrow morning I'm going hiking with some friends in the national park. The weather forecast looks perfect for it. What about you?

Emma: That sounds amazing! I love hiking, but this weekend I'm planning something more relaxed. I'm meeting my sister for brunch tomorrow, and then we're going shopping for her birthday present.

Jake: Nice! When's her birthday?

Emma: Next Thursday. I want to find something special for her. She's been working so hard lately, so I think she deserves a really nice gift. Maybe some jewelry or a spa day voucher.

Jake: That's so thoughtful of you! I bet she'll love whatever you choose. Are you doing anything on Sunday?

Emma: Well, Sunday is my catch-up day. I need to do laundry, clean the apartment, and prepare for the busy week ahead. I know it sounds boring, but I actually enjoy having a quiet day at home sometimes. Plus, I want to try cooking that new pasta recipe I found online.

Jake: That doesn't sound boring at all! Sometimes the best weekends are the ones where you can just relax and take care of yourself. After our hike tomorrow, I'm planning to have a movie marathon at home on Sunday.

Emma: Perfect! Well, I hope you have a wonderful hike and enjoy your movies. See you Monday!

Jake: Thanks Emma! Have a great weekend with your sister!`
                }
            };
            return audioData[audioType];
        }

        // Game variables
        let currentQuestion = 0;
        let score = 0;
        let totalQuestions = 5;
        let gameQuestions = [];
        let userAnswers = [];

        // Sample questions for each audio type
        const questionsData = {
            advice: [
                {
                    question: "What is the main topic of this audio?",
                    options: ["Travel tips", "Exam advice", "Cooking recipes", "Sports training"],
                    correct: 1
                },
                {
                    question: "According to Mark, when should students start studying for exams?",
                    options: ["The night before", "At least three weeks before", "One week before", "The morning of the exam"],
                    correct: 1
                },
                {
                    question: "What study technique does Mark recommend instead of just reading notes?",
                    options: ["Memorizing everything", "Active learning methods", "Passive reading only", "Group study always"],
                    correct: 1
                },
                {
                    question: "What does Mark say about taking care of health during exam preparation?",
                    options: ["It's not important", "Sleep and nutrition matter", "Only exercise matters", "Just drink coffee"],
                    correct: 1
                },
                {
                    question: "How does Sarah feel at the end of the conversation?",
                    options: ["More worried", "More confident", "Confused", "Angry"],
                    correct: 1
                }
            ],
            llamas: [
                {
                    question: "Where are llamas originally from?",
                    options: ["North America", "Europe", "South America", "Asia"],
                    correct: 2
                },
                {
                    question: "What family do llamas belong to?",
                    options: ["Horse family", "Camel family", "Sheep family", "Cow family"],
                    correct: 1
                },
                {
                    question: "How much weight can a llama carry?",
                    options: ["Up to 15 kg", "Up to 30 kg", "Up to 50 kg", "Up to 100 kg"],
                    correct: 1
                },
                {
                    question: "How do llamas primarily communicate with each other?",
                    options: ["Only barking", "Humming and body language", "Silent gestures only", "Roaring"],
                    correct: 1
                },
                {
                    question: "What do llamas do when they feel threatened?",
                    options: ["Run away only", "Spit", "Hide underground", "Play dead"],
                    correct: 1
                }
            ],
            weekend: [
                {
                    question: "What day of the week is this conversation taking place?",
                    options: ["Monday", "Friday", "Saturday", "Sunday"],
                    correct: 1
                },
                {
                    question: "What is Jake planning to do on Saturday morning?",
                    options: ["Go shopping", "Go hiking", "Stay home", "Visit family"],
                    correct: 1
                },
                {
                    question: "Why is Emma shopping for a birthday present?",
                    options: ["For her mother", "For her sister", "For Jake", "For herself"],
                    correct: 1
                },
                {
                    question: "What does Emma plan to do on Sunday?",
                    options: ["Go hiking", "Meet friends", "Household tasks and cooking", "Go to the movies"],
                    correct: 2
                },
                {
                    question: "What is Jake's Sunday plan?",
                    options: ["More hiking", "Movie marathon at home", "Shopping", "Visiting Emma"],
                    correct: 1
                }
            ]
        };

        // Navigation functions
        function showTutorial() {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('tutorial-screen').classList.add('active');
        }

        function showRules() {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('rules-screen').classList.add('active');
        }

        function showAudioSelection() {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('audio-selection-screen').classList.add('active');
            updateCarousel(); // Initialize carousel
        }

        function backToAudioSelection() {
            // Reset game state
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            
            // Stop and cleanup audio
            stopAndCleanupAudio();
            
            showAudioSelection();
        }

        function stopAndCleanupAudio() {
            // Stop all audio and reset
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
            }

            if (gameAudio) {
                gameAudio.pause();
                gameAudio.currentTime = 0;
            }

            // Reset audio player UI
            document.getElementById('play-btn').style.display = 'block';
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('audio-progress-fill').style.width = '0%';
            document.getElementById('current-time').textContent = '0:00';
            document.getElementById('total-time').textContent = '0:00';
        }

        function skipTutorial() {
            showRules();
        }

        // Tutorial navigation
        let currentTutorialStep = 1;
        const totalTutorialSteps = 5;

        function nextTutorial() {
            if (currentTutorialStep < totalTutorialSteps) {
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.remove('active');
                currentTutorialStep++;
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.add('active');
                updateTutorialDots();
            }
        }

        function prevTutorial() {
            if (currentTutorialStep > 1) {
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.remove('active');
                currentTutorialStep--;
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.add('active');
                updateTutorialDots();
            }
        }

        function updateTutorialDots() {
            document.querySelectorAll('.tutorial-step.active .dot').forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 === currentTutorialStep);
            });
        }

        // Game functions
        function startGame() {
            // Initialize game
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            gameQuestions = questionsData[selectedAudioType];

            // Set up game audio
            const audioInfo = getAudioInfo(selectedAudioType);
            gameAudio.src = audioInfo.file;
            currentAudio = gameAudio;

            // Show game screen
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('game-screen').classList.add('active');

            // Load first question
            loadQuestion();
            
            // Set up audio player
            setupAudioPlayer();
        }

        function setupAudioPlayer() {
            const playBtn = document.getElementById('play-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const restartBtn = document.getElementById('restart-btn');
            const progressBar = document.getElementById('audio-progress-bar');
            const progressFill = document.getElementById('audio-progress-fill');
            const currentTimeSpan = document.getElementById('current-time');
            const totalTimeSpan = document.getElementById('total-time');

            // Remove existing event listeners to prevent duplicates
            playBtn.replaceWith(playBtn.cloneNode(true));
            pauseBtn.replaceWith(pauseBtn.cloneNode(true));
            restartBtn.replaceWith(restartBtn.cloneNode(true));

            // Get fresh references
            const newPlayBtn = document.getElementById('play-btn');
            const newPauseBtn = document.getElementById('pause-btn');
            const newRestartBtn = document.getElementById('restart-btn');

            newPlayBtn.addEventListener('click', () => {
                currentAudio.play();
                newPlayBtn.style.display = 'none';
                newPauseBtn.style.display = 'block';
            });

            newPauseBtn.addEventListener('click', () => {
                currentAudio.pause();
                newPauseBtn.style.display = 'none';
                newPlayBtn.style.display = 'block';
            });

            newRestartBtn.addEventListener('click', () => {
                currentAudio.currentTime = 0;
                if (currentAudio.paused) {
                    newPlayBtn.style.display = 'block';
                    newPauseBtn.style.display = 'none';
                }
            });

            // Enhanced progress bar functionality - allows clicking to seek
            progressBar.addEventListener('click', (e) => {
                if (currentAudio.duration) {
                    const rect = progressBar.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const percentage = clickX / width;
                    currentAudio.currentTime = currentAudio.duration * percentage;
                }
            });

            // Keyboard navigation for progress bar
            progressBar.addEventListener('keydown', (e) => {
                if (currentAudio.duration) {
                    const jumpTime = currentAudio.duration * 0.05; // 5% jumps
                    
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        currentAudio.currentTime = Math.max(0, currentAudio.currentTime - jumpTime);
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        currentAudio.currentTime = Math.min(currentAudio.duration, currentAudio.currentTime + jumpTime);
                    }
                }
            });

            currentAudio.addEventListener('loadedmetadata', () => {
                totalTimeSpan.textContent = formatTime(currentAudio.duration);
            });

            currentAudio.addEventListener('timeupdate', () => {
                if (currentAudio.duration) {
                    const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                    progressFill.style.width = `${progress}%`;
                    currentTimeSpan.textContent = formatTime(currentAudio.currentTime);
                    
                    // Update ARIA attributes for accessibility
                    progressBar.setAttribute('aria-valuenow', Math.round(progress));
                    progressBar.setAttribute('aria-valuetext', `${formatTime(currentAudio.currentTime)} of ${formatTime(currentAudio.duration)}`);
                }
            });

            currentAudio.addEventListener('ended', () => {
                newPlayBtn.style.display = 'block';
                newPauseBtn.style.display = 'none';
            });
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function loadQuestion() {
            const question = gameQuestions[currentQuestion];
            
            // Hide answer required message
            document.getElementById('answer-required-message').classList.remove('show');
            
            // Clear previous option selections and styles
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Update UI
            document.getElementById('current-story').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('story-title').textContent = getAudioInfo(selectedAudioType).title;
            document.getElementById('question-text').textContent = question.question;
            
            // Update progress
            const progress = (currentQuestion / totalQuestions) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            
            // Update score display
            const currentScorePercent = Math.round((score / totalQuestions) * 100);
            document.getElementById('current-score').textContent = `${currentScorePercent}%`;
            
            // Load options
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.innerHTML = `
                    <input type="radio" name="answer" id="option-${index}" value="${index}">
                    <label for="option-${index}">${option}</label>
                `;
                
                // Add click handler for visual feedback
                optionDiv.addEventListener('click', () => {
                    document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    optionDiv.classList.add('selected');
                    document.getElementById(`option-${index}`).checked = true;
                });
                
                optionsContainer.appendChild(optionDiv);
            });
            
            // Show question section, hide feedback
            document.getElementById('question-section').style.display = 'block';
            document.getElementById('feedback-section').style.display = 'none';
            
            // Reset submit button
            document.getElementById('submit-btn').disabled = false;
        }

        function submitAnswer() {
            const selectedOption = document.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                // Show answer required message with enhanced animation
                const messageElement = document.getElementById('answer-required-message');
                messageElement.classList.add('show');
                
                // Add shake animation to the entire question section
                const questionSection = document.getElementById('question-section');
                questionSection.style.animation = 'none';
                setTimeout(() => {
                    questionSection.style.animation = 'shake 0.5s ease-in-out';
                }, 10);
                
                // Hide message after 3 seconds
                setTimeout(() => {
                    messageElement.classList.remove('show');
                    questionSection.style.animation = 'none';
                }, 3000);
                
                return;
            }

            const userAnswer = parseInt(selectedOption.value);
            const correctAnswer = gameQuestions[currentQuestion].correct;
            const isCorrect = userAnswer === correctAnswer;
            
            // Store answer
            userAnswers.push({
                question: currentQuestion,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });
            
            // Update score (20% per correct answer)
            if (isCorrect) {
                score++;
            }
            
            // Add visual feedback to options
            document.querySelectorAll('.option').forEach((option, index) => {
                if (index === correctAnswer) {
                    option.classList.add('correct');
                } else if (index === userAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });
            
            // Disable submit button to prevent double submission
            document.getElementById('submit-btn').disabled = true;
            
            // Show feedback after a brief delay to let animations play
            setTimeout(() => {
                showFeedback(isCorrect, correctAnswer);
            }, 1000);
        }

        function showFeedback(isCorrect, correctAnswer) {
            const feedbackContent = document.getElementById('feedback-content');
            const question = gameQuestions[currentQuestion];
            
            feedbackContent.innerHTML = `
                <div class="feedback-result ${isCorrect ? 'correct' : 'incorrect'}">
                    <div class="feedback-icon">${isCorrect ? '‚úÖ' : '‚ùå'}</div>
                    <div class="feedback-text">
                        <h3>${isCorrect ? 'Excellent!' : 'Not quite right'}</h3>
                        <p>The correct answer is: <strong>${question.options[correctAnswer]}</strong></p>
                        ${isCorrect ? '<p>Great listening skills! Keep it up!</p>' : '<p>Don\'t worry, practice makes perfect!</p>'}
                    </div>
                </div>
                <div class="score-update">
                    Current Score: ${Math.round((score / totalQuestions) * 100)}% (${score}/${totalQuestions} correct)
                </div>
            `;
            
            // Update next button text
            const nextBtn = document.getElementById('next-btn');
            if (currentQuestion === totalQuestions - 1) {
                nextBtn.textContent = '‚Üí';
                nextBtn.style.background = '#FFFFFF';
            } else {
                nextBtn.textContent = 'Next Question ‚Üí';
                nextBtn.style.background = '#00a86b';
            }
            
            // Hide question, show feedback
            document.getElementById('question-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'block';
        }

        function nextStory() {
            currentQuestion++;
            
            if (currentQuestion >= totalQuestions) {
                // Stop audio before showing results
                stopAndCleanupAudio();
                showResults();
            } else {
                loadQuestion();
            }
        }

        function showResults() {
            // Calculate final stats
            const finalScore = Math.round((score / totalQuestions) * 100);
            const accuracy = finalScore;
            
            // Update final stats display
            document.getElementById('final-score').textContent = `${finalScore}%`;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;
            document.getElementById('final-correct').textContent = `${score}/${totalQuestions}`;
            
            // Generate performance list
            const performanceList = document.getElementById('performance-list');
            performanceList.innerHTML = '';
            
            userAnswers.forEach((answer, index) => {
                const question = gameQuestions[answer.question];
                const performanceItem = document.createElement('div');
                performanceItem.className = `performance-item ${answer.isCorrect ? 'correct' : 'incorrect'}`;
                performanceItem.innerHTML = `
                    <div class="performance-icon">${answer.isCorrect ? '‚úÖ' : '‚ùå'}</div>
                    <div class="performance-details">
                        <div class="performance-question">Question ${index + 1}: ${question.question.substring(0, 50)}...</div>
                        <div class="performance-result">${answer.isCorrect ? 'Correct' : 'Incorrect'} - ${question.options[answer.correctAnswer]}</div>
                    </div>
                `;
                performanceList.appendChild(performanceItem);
            });
            
            // Show complete screen
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('complete-screen').classList.add('active');
        }

function playAgain() {
    // Reset carousel to first item
    currentCarouselIndex = 0;
    selectedAudioType = 'advice';
    
    // Reset all game variables
    currentQuestion = 0;
    score = 0;
    userAnswers = [];
    
    // Stop and cleanup audio
    stopAndCleanupAudio();
    
    // Hide any modals or overlays that might be showing
    closeAudioModal();
    document.getElementById('transcript-modal').style.display = 'none';
    
    // Remove any temporary elements that might have been added
    const tempElements = document.querySelectorAll('.temp-result-overlay, .view-results-btn');
    tempElements.forEach(el => el.remove());
    
    // Show audio selection screen
    showAudioSelection();
    
    // Force carousel update to fix arrow states
    setTimeout(() => {
        updateCarousel();
        
        // Additional cleanup for carousel display
        const carousel = document.getElementById('audio-carousel');
        const cards = carousel.querySelectorAll('.audio-card');
        
        // Ensure only audio cards are visible and properly positioned
        cards.forEach((card, index) => {
            card.style.display = 'block';
            card.classList.remove('center');
            if (index === 0) {
                card.classList.add('center');
            }
        });
    }, 100);
}

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        // Transcript functionality
        function closeTranscript() {
            document.getElementById('transcript-modal').style.display = 'none';
        }

        document.getElementById('transcript-btn').addEventListener('click', () => {
            loadTranscript();
            document.getElementById('transcript-modal').style.display = 'flex';
        });

        function loadTranscript() {
            const transcriptText = document.getElementById('transcript-text');
            
            if (selectedAudioType) {
                const audioInfo = getAudioInfo(selectedAudioType);
                transcriptText.innerHTML = `<div style="line-height: 1.8; font-size: 1rem; color: #333;">${audioInfo.transcript.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</div>`;
            } else {
                transcriptText.textContent = 'Transcript not available.';
            }
        }

        // Speed control
        let currentSpeed = 1;
        const speeds = [0.5, 0.75, 1, 1.25, 1.5];

        document.getElementById('speed-btn').addEventListener('click', () => {
            const currentIndex = speeds.indexOf(currentSpeed);
            currentSpeed = speeds[(currentIndex + 1) % speeds.length];
            if (currentAudio) {
                currentAudio.playbackRate = currentSpeed;
            }
            document.getElementById('speed-btn').textContent = `Speed: ${currentSpeed}x`;
        });

        // Volume control
        document.getElementById('volume-btn').addEventListener('click', () => {
            if (currentAudio) {
                currentAudio.muted = !currentAudio.muted;
                document.getElementById('volume-btn').textContent = currentAudio.muted ? 'üîá' : 'üîä';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Only handle shortcuts when in game screen
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            
            switch(e.key) {
                case ' ': // Spacebar to play/pause
                    e.preventDefault();
                    if (currentAudio && currentAudio.paused) {
                        document.getElementById('play-btn').click();
                    } else {
                        document.getElementById('pause-btn').click();
                    }
                    break;
                case 'r': // R to restart
                    e.preventDefault();
                    document.getElementById('restart-btn').click();
                    break;
                case 't': // T to toggle transcript
                    e.preventDefault();
                    document.getElementById('transcript-btn').click();
                    break;
                case 's': // S to change speed
                    e.preventDefault();
                    document.getElementById('speed-btn').click();
                    break;
            }
        });

        // Initialize image loading
        function loadAudioImages() {
            const audioCards = document.querySelectorAll('.audio-card-image');
            audioCards.forEach(card => {
                const audioType = card.parentElement.dataset.audio;
                const audioInfo = getAudioInfo(audioType);
                
                // Try to load the image, fallback to gradient if not found
                const img = new Image();
                img.onload = () => {
                    card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${audioInfo.image}')`;
                };
                img.onerror = () => {
                    // Keep the current gradient background
                    console.log(`Image not found: ${audioInfo.image}`);
                };
                img.src = audioInfo.image;
            });
        }

        // Initialize carousel indicators
        document.querySelectorAll('.carousel-indicator').forEach((indicator, index) => {
            indicator.addEventListener('click', () => {
                currentCarouselIndex = index;
                updateCarousel();
            });
        });

        // Enhanced close transcript functionality
        document.getElementById('transcript-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('transcript-modal')) {
                closeTranscript();
            }
        });

        // Close transcript with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('transcript-modal').style.display === 'flex') {
                closeTranscript();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Show tutorial by default
            document.getElementById('tutorial-screen').classList.add('active');
            
            // Initialize carousel
            updateCarousel();
            
            // Load images
            loadAudioImages();
            
            // Close modal when clicking outside
            document.getElementById('audio-selection-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('audio-selection-modal')) {
                    closeAudioModal();
                }
            });

            // Add hover effect for transcript close button
            const closeBtn = document.querySelector('.close-transcript');
            if (closeBtn) {
                closeBtn.addEventListener('mouseenter', () => {
                    closeBtn.style.background = 'rgba(255,255,255,0.2)';
                });
                closeBtn.addEventListener('mouseleave', () => {
                    closeBtn.style.background = 'none';
                });
            }
        });
    </script>
</body>
</html>