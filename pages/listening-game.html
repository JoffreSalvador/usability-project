<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listening Game - EnglishMaster</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css" />
    <link rel="stylesheet" href="../assets/css/games.css" />
    <link rel="stylesheet" href="../assets/css/listening-game.css" />
    <style>
        /* Audio Selection Screen Styles - Carousel Style */
        .audio-selection-screen {
            background: #e8fff0;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .audio-selection-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .audio-selection-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .audio-selection-title {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .audio-selection-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 2rem;
        }

        /* Progressive Score Display */
        .progressive-score-display {
            background: linear-gradient(135deg, #00a86b, #008f5a);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,168,107,0.3);
        }

        .progressive-score-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .progressive-score-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .progressive-score-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Carousel Styles */
        .audio-carousel-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .audio-carousel {
            display: flex;
            transition: transform 0.5s ease;
            gap: 2rem;
        }

        .audio-card {
            min-width: 350px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: scale(0.9);
            opacity: 0.7;
            position: relative;
        }

        .audio-card.center {
            transform: scale(1);
            opacity: 1;
            border-color: #00a86b;
            box-shadow: 0 12px 35px rgba(0,168,107,0.2);
        }

        .audio-card:hover {
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .audio-card.center:hover {
            transform: scale(1.02);
        }

        /* Audio completion badge */
        .audio-completion-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #00a86b;
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 2;
            display: none;
        }

        .audio-completion-badge.show {
            display: block;
        }

        .audio-completion-badge.perfect {
            background: #f39c12;
        }
        
        .audio-card-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        
        .audio-card-image.advice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .audio-card-image.llamas {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .audio-card-image.weekend {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .audio-card-emoji {
            font-size: 4rem;
            position: relative;
            z-index: 2;
        }
        
        .audio-card-content {
            padding: 2rem;
        }
        
        .audio-card-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 0.8rem;
            color: #333;
        }
        
        .audio-card-description {
            color: #666;
            margin-bottom: 1.2rem;
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .audio-card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .difficulty-tag {
            background: #00a86b;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .category-tag {
            color: #666;
            font-size: 0.9rem;
        }

        /* Audio progress indicator */
        .audio-progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-top: 1px solid #eee;
            margin-top: 1rem;
        }

        .progress-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .progress-score {
            font-size: 0.85rem;
            font-weight: bold;
        }

        .progress-score.not-started {
            color: #999;
        }

        .progress-score.completed {
            color: #00a86b;
        }

        .progress-score.perfect {
            color: #f39c12;
        }

        .carousel-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .carousel-btn {
            background: white;
            border: 2px solid #00a86b;
            color: #00a86b;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .carousel-btn:hover:not(:disabled) {
            background: #00a86b;
            color: white;
            transform: scale(1.1);
        }

        .carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .carousel-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-indicator.active {
            background: #00a86b;
            transform: scale(1.2);
        }

        .select-audio-btn {
            background: #00a86b;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,168,107,0.3);
        }

        .select-audio-btn:hover {
            background: #008f5a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,168,107,0.4);
        }

        /* Audio Selection Modal */
        .audio-selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .audio-selection-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .audio-selection-modal.show .modal-content {
            transform: scale(1);
        }

        .modal-audio-info {
            margin-bottom: 2rem;
        }

        .modal-audio-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00a86b;
            margin-bottom: 0.5rem;
        }

        .modal-audio-description {
            color: #666;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .modal-previous-score {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .modal-previous-score h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 0.9rem;
        }

        .modal-previous-score .score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00a86b;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-btn.primary {
            background: #00a86b;
            color: white;
        }

        .modal-btn.secondary {
            background: white;
            color: #00a86b;
            border: 2px solid #00a86b;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .modal-btn.primary:hover {
            background: #008f5a;
        }

        .modal-btn.secondary:hover {
            background: #f0fff4;
        }

        /* Answer validation message */
        .answer-required-message {
            background: #ff4757;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .answer-required-message.show {
            display: block;
        }
        
        /* Updated audio player with navigation */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .audio-controls-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .audio-progress-section {
            flex: 1;
            min-width: 200px;
        }
        
        .audio-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
        }
        
        .audio-progress-fill {
            height: 100%;
            background: #00a86b;
            border-radius: 10px;
            transition: width 0.2s;
            width: 0%;
        }
        
        .audio-progress-bar:hover .audio-progress-fill {
            background: #008f5a;
        }
        
        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Enhanced audio controls */
        .audio-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: white;
            border: 2px solid #00a86b;
            color: #00a86b;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .control-btn:hover {
            background: #00a86b;
            color: white;
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: #00a86b;
            color: white;
        }

        /* Enhanced feedback section */
        .feedback-result {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border-left: 5px solid #ddd;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            animation: feedbackSlideIn 0.5s ease-out;
        }

        /* Spacing for feedback section */
        .feedback-section {
            margin-top: 2rem;
        }

        .feedback-content {
            margin-bottom: 2rem;
        }

        .feedback-result.correct {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left-color: #28a745;
            color: #155724;
        }

        .feedback-result.incorrect {
            background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
            border-left-color: #dc3545;
            color: #721c24;
        }

        .feedback-icon {
            font-size: 3rem;
            min-width: 60px;
            text-align: center;
            animation: feedbackPulse 0.6s ease-out;
        }

        .feedback-text h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .feedback-text p {
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .score-update {
            background: #00a86b;
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,168,107,0.3);
            animation: scoreUpdate 0.6s ease-out;
        }

        @keyframes feedbackSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes feedbackPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes scoreUpdate {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Enhanced option selection feedback */
        .option {
            transition: all 0.3s ease;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .option.selected {
            background: rgba(0,168,107,0.1);
            border-color: #00a86b;
            transform: translateX(5px);
        }

        .option.correct {
            background: rgba(40,167,69,0.1);
            border-color: #28a745;
            animation: correctAnswer 0.6s ease-out;
        }

        .option.incorrect {
            background: rgba(220,53,69,0.1);
            border-color: #dc3545;
            animation: incorrectAnswer 0.6s ease-out;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); background: rgba(40,167,69,0.2); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        /* Progressive results styling */
        .progressive-results {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .progressive-results h3 {
            color: #00a86b;
            margin-bottom: 1rem;
        }

        .audio-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .audio-result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .audio-result-card.completed {
            border-left-color: #00a86b;
        }

        .audio-result-card.perfect {
            border-left-color: #f39c12;
        }

        .audio-result-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .audio-result-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00a86b;
        }

        .audio-result-score.perfect {
            color: #f39c12;
        }

        .audio-result-score.not-started {
            color: #999;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .audio-card {
                min-width: 300px;
            }
            
            .audio-card-image {
                height: 150px;
            }
            
            .audio-card-emoji {
                font-size: 3rem;
            }
            
            .audio-player {
                justify-content: center;
            }
            
            .audio-progress-section {
                order: 3;
                width: 100%;
            }
            
            .audio-selection-title {
                font-size: 1.8rem;
            }

            .modal-content {
                padding: 2rem;
                margin: 1rem;
            }

            .modal-actions {
                flex-direction: column;
            }

            .feedback-result {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .audio-results-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Accessibility improvements */
        .audio-card:focus {
            outline: 3px solid #00a86b;
            outline-offset: 2px;
        }
        
        @media (prefers-reduced-motion: reduce) {
            .audio-card,
            .control-btn,
            .audio-carousel,
            .feedback-result {
                transition: none;
                animation: none;
            }
            
            .audio-card:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="left">
                <a href="dashboard.html" class="logo">
                    <img src="../assets/img/logo.png" alt="EnglishMaster Logo" />
                </a>
            </div>
            <div class="center">
                <nav aria-label="Main Navigation">
                    <ul class="nav-list">
                        <li><a href="features.html">Features</a></li>
                        <li><a href="games.html" class="active">Games</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="resumen-usabilidad.html">View Progress</a></li>
                    </ul>
                </nav>
            </div>
            <div class="right auth-buttons" id="authArea" style="opacity: 0; transition: opacity 0.3s ease-in-out;">
                <a href="login.html" class="btn-outline" id="signInBtn">Sign In</a>
                <a href="register.html" class="btn-filled" id="getStartedBtn">Get Started</a>

                <div id="userInfo" style="display: none;">
                    <span id="userName" class="text-lg font-semibold mr-2"></span>
                    <button id="logoutBtn" class="btn-outline">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="listening-game-main">
        <!-- Tutorial Screens -->
        <div id="tutorial-screen" class="screen active">
            <div class="tutorial-container">
                <div class="tutorial-header">
                    <div class="game-badge">
                        <div class="game-icon-large">üéµ</div>
                        <span>Listening Game</span>
                    </div>
                    <button class="skip-tutorial-btn" onclick="skipTutorial()">Skip Tutorial</button>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-step active" data-step="1">
                        <div class="tutorial-icon">üéµ</div>
                        <h2>Welcome to Listening Game!</h2>
                        <p>Master your English listening skills with fun interactive audio stories!</p>
                        <div class="tutorial-dots">
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                        <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                    </div>

                    <div class="tutorial-step" data-step="2">
                        <div class="tutorial-icon">üéß</div>
                        <h2>Ready to Expand Your Listening Skills?</h2>
                        <p>This game will test your English listening comprehension through interactive audio stories</p>
                        <div class="tutorial-benefits">
                            <div class="benefit-item">‚Ä¢ New English conversation contexts</div>
                            <div class="benefit-item">‚Ä¢ Audio comprehension improvement</div>
                            <div class="benefit-item">‚Ä¢ Context and story exercises</div>
                            <div class="benefit-item">‚Ä¢ Speaking and pronunciation</div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                        </div>
                    </div>

                    <div class="tutorial-step" data-step="3">
                        <div class="tutorial-icon">üèÜ</div>
                        <h2>Progressive Scoring System</h2>
                        <p>Complete all 3 audio stories to achieve 100% mastery!</p>
                        <div class="scoring-system">
                            <div class="score-item correct">
                                <div class="score-icon">‚úÖ</div>
                                <div class="score-details">
                                    <h4>Per Audio Story</h4>
                                    <p>Each audio has 5 questions - complete all 3 for 100%</p>
                                </div>
                            </div>
                            <div class="score-item perfect">
                                <div class="score-icon">üéØ</div>
                                <div class="score-details">
                                    <h4>Cumulative Progress</h4>
                                    <p>Your progress saves - repeat audios to improve your score</p>
                                </div>
                            </div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                        </div>
                    </div>

                    <div class="tutorial-step" data-step="4">
                        <div class="tutorial-icon">üí°</div>
                        <h2>Tips for Success</h2>
                        <p>Learn strategies to improve your vocabulary learning experience.</p>
                        <div class="tips-list">
                            <div class="tip-item">
                                <span class="tip-icon">üéß</span>
                                <div class="tip-content">
                                    <h4>Listen Carefully</h4>
                                    <p>Take your time to understand the context before answering</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">üìñ</span>
                                <div class="tip-content">
                                    <h4>Learn from Audio</h4>
                                    <p>Use transcripts when needed to improve comprehension</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">üîÑ</span>
                                <div class="tip-content">
                                    <h4>Practice Regularly</h4>
                                    <p>Repeat audios to improve your overall progress</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">üéØ</span>
                                <div class="tip-content">
                                    <h4>Use Context Clues</h4>
                                    <p>Pay attention to tone, emotions, and background sounds</p>
                                </div>
                            </div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled tutorial-next" onclick="nextTutorial()">Next</button>
                        </div>
                    </div>

                    <div class="tutorial-step" data-step="5">
                        <div class="tutorial-icon">‚úÖ</div>
                        <h2>Ready to Start!</h2>
                        <p>You're all set to begin your progressive listening adventure!</p>
                        <div class="ready-message">
                            <div class="ready-icon">‚úÖ</div>
                            <h3>You're Ready to Play!</h3>
                            <p>Start with any audio story and build your progress. Work towards 100% mastery!</p>
                        </div>
                        <div class="game-features">
                            <h4>Game Features:</h4>
                            <div class="feature-list">
                                <div class="feature-item">‚úÖ 3 unique audio stories</div>
                                <div class="feature-item">‚úÖ 5 questions per story</div>
                                <div class="feature-item">‚úÖ Progressive scoring system</div>
                                <div class="feature-item">‚úÖ Replay to improve scores</div>
                            </div>
                        </div>
                        <div class="tutorial-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                        </div>
                        <div class="tutorial-nav">
                            <button class="btn-outline tutorial-prev" onclick="prevTutorial()">Previous</button>
                            <button class="btn-filled start-playing" onclick="showRules()">Start Playing Now! ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <div class="rules-container">
                <div class="rules-header">
                    <button class="back-btn" onclick="showTutorial()">‚Üê Back to Tutorial</button>
                    <div class="game-badge">
                        <div class="game-icon-large">üéµ</div>
                        <span>Listening Game</span>
                    </div>
                </div>
                
                <div class="rules-content">
                    <h2>Progressive Audio Challenge</h2>
                    <p class="rules-subtitle">Complete all 3 audio stories to achieve 100% mastery!</p>
                    
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-number">3</div>
                            <div class="stat-label">Audio Stories</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">15</div>
                            <div class="stat-label">Total Questions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">100%</div>
                            <div class="stat-label">Max Score</div>
                        </div>
                    </div>

                    <div class="game-rules">
                        <h3>How Progressive Scoring Works:</h3>
                        <ul class="rules-list">
                            <li>‚Ä¢ Complete all 3 audio stories to reach 100%</li>
                            <li>‚Ä¢ Each audio contributes to your total progress</li>
                            <li>‚Ä¢ Your progress is saved automatically</li>
                            <li>‚Ä¢ Replay any audio to improve your score</li>
                            <li>‚Ä¢ Example: 3/5 + 4/5 + 2/5 = 9/15 = 60% total</li>
                        </ul>
                    </div>

                    <button class="btn-filled start-game-btn" onclick="showAudioSelection()">Select Audio ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Audio Selection Screen - Carousel Style -->
        <div id="audio-selection-screen" class="screen">
            <div class="audio-selection-screen">
                <div class="audio-selection-container">
                    <div class="audio-selection-header">
                        <button class="back-btn" onclick="showRules()">‚Üê Back to Rules</button>
                        <h1 class="audio-selection-title">Choose Your Audio Story</h1>
                        <p class="audio-selection-subtitle">Complete all 3 stories to achieve 100% mastery</p>
                        
                        <!-- Progressive Score Display -->
                        <div class="progressive-score-display">
                            <div class="progressive-score-title">Your Overall Progress</div>
                            <div class="progressive-score-value" id="overall-progress">0%</div>
                            <div class="progressive-score-details" id="progress-details">0/15 questions completed</div>
                        </div>
                    </div>

                    <div class="audio-carousel-container">
                        <div class="audio-carousel" id="audio-carousel">
                            <div class="audio-card center" data-audio="advice">
                                <div class="audio-completion-badge" id="advice-badge">Not Started</div>
                                <div class="audio-card-image advice">
                                    <div class="audio-card-emoji">üí°</div>
                                </div>
                                <div class="audio-card-content">
                                    <h3 class="audio-card-title">B2 Advice for Exams</h3>
                                    <p class="audio-card-description">Learn valuable study tips and exam strategies from experienced students and teachers.</p>
                                    <div class="audio-card-info">
                                        <span class="difficulty-tag">Intermediate</span>
                                        <span class="category-tag">üìö Educational</span>
                                    </div>
                                    <div class="audio-progress-indicator">
                                        <span class="progress-label">Progress:</span>
                                        <span class="progress-score not-started" id="advice-progress">0/5</span>
                                    </div>
                                </div>
                            </div>

                            <div class="audio-card" data-audio="llamas">
                                <div class="audio-completion-badge" id="llamas-badge">Not Started</div>
                                <div class="audio-card-image llamas">
                                    <div class="audio-card-emoji">ü¶ô</div>
                                </div>
                                <div class="audio-card-content">
                                    <h3 class="audio-card-title">B2 Llamas</h3>
                                    <p class="audio-card-description">Discover fascinating facts about llamas and their role in South American culture.</p>
                                    <div class="audio-card-info">
                                        <span class="difficulty-tag">Intermediate</span>
                                        <span class="category-tag">üåç Culture & Nature</span>
                                    </div>
                                    <div class="audio-progress-indicator">
                                        <span class="progress-label">Progress:</span>
                                        <span class="progress-score not-started" id="llamas-progress">0/5</span>
                                    </div>
                                </div>
                            </div>

                            <div class="audio-card" data-audio="weekend">
                                <div class="audio-completion-badge" id="weekend-badge">Not Started</div>
                                <div class="audio-card-image weekend">
                                    <div class="audio-card-emoji">üåü</div>
                                </div>
                                <div class="audio-card-content">
                                    <h3 class="audio-card-title">B2 The Weekend</h3>
                                    <p class="audio-card-description">Join a conversation about weekend plans, activities, and memorable experiences.</p>
                                    <div class="audio-card-info">
                                        <span class="difficulty-tag">Intermediate</span>
                                        <span class="category-tag">üí¨ Conversation</span>
                                    </div>
                                    <div class="audio-progress-indicator">
                                        <span class="progress-label">Progress:</span>
                                        <span class="progress-score not-started" id="weekend-progress">0/5</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="carousel-controls">
                            <button class="carousel-btn" id="prev-btn" onclick="previousAudio()">‚Äπ</button>
                            <div class="carousel-indicators">
                                <div class="carousel-indicator active" data-index="0"></div>
                                <div class="carousel-indicator" data-index="1"></div>
                                <div class="carousel-indicator" data-index="2"></div>
                            </div>
                            <button class="carousel-btn" id="next-btn" onclick="nextAudio()">‚Ä∫</button>
                        </div>

                        <div style="text-align: center;">
                            <button class="select-audio-btn" onclick="openAudioModal()">Select This Audio</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Selection Modal -->
        <div class="audio-selection-modal" id="audio-selection-modal">
            <div class="modal-content">
                <div class="modal-audio-info">
                    <h3 class="modal-audio-title" id="modal-audio-title">B2 Advice for Exams</h3>
                    <p class="modal-audio-description" id="modal-audio-description">Learn valuable study tips and exam strategies from experienced students and teachers.</p>
                    <div class="modal-previous-score" id="modal-previous-score">
                        <h4>Previous Progress:</h4>
                        <div class="score" id="modal-score">Not Started</div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn primary" onclick="startGameFromModal()">Start/Continue Audio</button>
                    <button class="modal-btn secondary" onclick="closeAudioModal()">Choose Other Audio</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-container">
                <div class="game-header">
                    <div class="game-info">
                        <div class="game-badge-small">
                            <div class="game-icon-small">üéµ</div>
                            <span>Listening Game</span>
                        </div>
                        <div class="game-progress">
                            <span id="current-story">Question 1</span> of <span id="total-stories">5</span>
                        </div>
                    </div>
                    <div class="game-stats-header">
                        <div class="score-display">Overall Progress: <span id="current-overall-progress">0%</span></div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div class="story-content">
                    <div class="story-header">
                        <h2 id="story-title">A Morning at the Coffee Shop</h2>
                        <div class="difficulty-badge" id="difficulty-badge">Intermediate</div>
                    </div>

                    <!-- Enhanced Audio Player Section -->
                    <div class="audio-section">
                        <div class="audio-player">
                            <div class="audio-controls-left">
                                <button class="audio-btn play-btn" id="play-btn" aria-label="Play audio">
                                    <span class="play-icon">‚ñ∂Ô∏è</span>
                                </button>
                                <button class="audio-btn pause-btn" id="pause-btn" style="display: none;" aria-label="Pause audio">
                                    <span class="pause-icon">‚è∏Ô∏è</span>
                                </button>
                                <button class="audio-btn restart-btn" id="restart-btn" aria-label="Restart audio">
                                    <span class="restart-icon">‚èÆÔ∏è</span>
                                </button>
                                <button class="audio-btn volume-btn" id="volume-btn" aria-label="Toggle volume">üîä</button>
                            </div>
                            
                            <div class="audio-progress-section">
                                <div class="audio-progress-bar" id="audio-progress-bar" role="slider" aria-label="Audio progress" tabindex="0">
                                    <div class="audio-progress-fill" id="audio-progress-fill"></div>
                                </div>
                                <div class="audio-time">
                                    <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                                </div>
                            </div>
                        </div>
                        <div class="audio-controls">
                            <button class="control-btn" id="speed-btn">Speed: 1x</button>
                            <button class="control-btn" id="transcript-btn">Show Transcript</button>
                        </div>
                    </div>

                    <!-- Question Section -->
                    <div class="question-section" id="question-section">
                        <!-- Answer required message -->
                        <div class="answer-required-message" id="answer-required-message">
                            ‚ö†Ô∏è Please select an answer before submitting
                        </div>

                        <h3 class="question-text" id="question-text">
                            What did Sarah order at the coffee shop?
                        </h3>
                        
                        <div class="options-container" id="options-container">
                            <div class="option" data-option="0">
                                <input type="radio" name="answer" id="option-0" value="0">
                                <label for="option-0">A large cappuccino with extra foam</label>
                            </div>
                            <div class="option" data-option="1">
                                <input type="radio" name="answer" id="option-1" value="1">
                                <label for="option-1">Her usual morning coffee</label>
                            </div>
                            <div class="option" data-option="2">
                                <input type="radio" name="answer" id="option-2" value="2">
                                <label for="option-2">The new seasonal pumpkin drink</label>
                            </div>
                            <div class="option" data-option="3">
                                <input type="radio" name="answer" id="option-3" value="3">
                                <label for="option-3">A simple black coffee</label>
                            </div>
                        </div>

                        <button class="btn-filled submit-btn" id="submit-btn" onclick="submitAnswer()">Submit Answer</button>
                    </div>

                    <!-- Feedback Section -->
                    <div class="feedback-section" id="feedback-section" style="display: none;">
                        <div class="feedback-content" id="feedback-content">
                            <!-- Feedback will be inserted here -->
                        </div>
                        <button class="btn-filled next-btn" id="next-btn" onclick="nextStory()">Next Question ‚Üí</button>
                    </div>
                </div>

                <!-- Transcript Modal -->
                <div class="transcript-modal" id="transcript-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                    <div class="transcript-content" style="background: white; max-width: 600px; width: 90%; max-height: 80vh; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div class="transcript-header" style="background: #00a86b; color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.3rem;">Audio Transcript</h3>
                            <button class="close-transcript" onclick="closeTranscript()" style="background: none; border: none; color: white; font-size: 2rem; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.3s;">√ó</button>
                        </div>
                        <div class="transcript-text" id="transcript-text" style="padding: 2rem; line-height: 1.6; font-size: 1rem; max-height: 400px; overflow-y: auto;">
                            Loading transcript...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Complete Screen -->
        <div id="complete-screen" class="screen">
            <div class="complete-container">
                <div class="complete-header">
                    <button class="back-btn" onclick="backToAudioSelection()">‚Üê Select New Audio</button>
                    <div class="game-badge">
                        <div class="game-icon-large">üéµ</div>
                        <span>Audio Complete</span>
                    </div>
                </div>

                <div class="complete-content">
                    <div class="achievement-icon">üéØ</div>
                    <h2>Audio Story Completed!</h2>
                    <p class="complete-subtitle">Great progress on your listening journey!</p>

                    <div class="final-stats">
                        <div class="final-stat">
                            <div class="stat-number" id="final-audio-score">80%</div>
                            <div class="stat-label">This Audio</div>
                        </div>
                        <div class="final-stat">
                            <div class="stat-number" id="final-overall-score">27%</div>
                            <div class="stat-label">Overall Progress</div>
                        </div>
                        <div class="final-stat">
                            <div class="stat-number" id="final-correct">4/5</div>
                            <div class="stat-label">Correct</div>
                        </div>
                    </div>

                    <div class="progressive-results">
                        <h3>Your Progress Across All Audio Stories</h3>
                        <div class="audio-results-grid" id="audio-results-grid">
                            <!-- Audio results will be populated here -->
                        </div>
                        <div class="progress-encouragement" id="progress-encouragement">
                            <!-- Encouragement message will be shown here -->
                        </div>
                    </div>

                    <div class="performance-summary">
                        <h3>This Audio Performance</h3>
                        <div class="performance-list" id="performance-list">
                            <!-- Performance items will be inserted here -->
                        </div>
                    </div>

                    <div class="complete-actions">
                        <button class="btn-outline play-again-btn" onclick="playAgain()">
                            üîÑ Try Different Audio
                        </button>
                        <button class="btn-outline" onclick="retryCurrentAudio()">
                            üîÑ Retry This Audio
                        </button>
                        <button class="btn-filled dashboard-btn" onclick="goToDashboard()">
                            üìä Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Audio elements for previews -->
    <audio id="preview-audio" style="display: none;"></audio>
    <audio id="game-audio" style="display: none;"></audio>

    <!-- Incluir los scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <!-- Tu script de autenticaci√≥n UI -->
    <script src="../utils/auth-ui.js"></script>

    <!-- Script espec√≠fico del juego -->
    <script>
        // Variables globales
        let selectedAudioType = 'advice'; // Default selection
        let currentAudio = null;
        let previewAudio = document.getElementById('preview-audio');
        let gameAudio = document.getElementById('game-audio');
        let currentCarouselIndex = 0;
        const audioTypes = ['advice', 'llamas', 'weekend'];

        // Progressive scoring system
        let progressiveScores = {
            advice: { completed: 0, total: 5 },
            llamas: { completed: 0, total: 5 },
            weekend: { completed: 0, total: 5 }
        };

        // Load progress from localStorage
        function loadProgressiveScores() {
            const saved = localStorage.getItem('listening-game-progress');
            if (saved) {
                progressiveScores = JSON.parse(saved);
            }
        }

        // Save progress to localStorage
        function saveProgressiveScores() {
            localStorage.setItem('listening-game-progress', JSON.stringify(progressiveScores));
        }

        // Calculate overall progress percentage
        function calculateOverallProgress() {
            const totalCompleted = progressiveScores.advice.completed + 
                                 progressiveScores.llamas.completed + 
                                 progressiveScores.weekend.completed;
            const totalPossible = 15; // 3 audios √ó 5 questions each
            return Math.round((totalCompleted / totalPossible) * 100);
        }

        // Update progress display
        function updateProgressDisplay() {
            const overallPercent = calculateOverallProgress();
            const totalCompleted = progressiveScores.advice.completed + 
                                 progressiveScores.llamas.completed + 
                                 progressiveScores.weekend.completed;
            
            // Update overall progress display
            document.getElementById('overall-progress').textContent = `${overallPercent}%`;
            document.getElementById('progress-details').textContent = `${totalCompleted}/15 questions completed`;
            
            // Update current overall progress in game screen
            const gameProgressElement = document.getElementById('current-overall-progress');
            if (gameProgressElement) {
                gameProgressElement.textContent = `${overallPercent}%`;
            }
            
            // Update individual audio progress
            audioTypes.forEach(audioType => {
                const progressElement = document.getElementById(`${audioType}-progress`);
                const badgeElement = document.getElementById(`${audioType}-badge`);
                const score = progressiveScores[audioType];
                
                if (progressElement) {
                    progressElement.textContent = `${score.completed}/${score.total}`;
                    progressElement.className = 'progress-score';
                    
                    if (score.completed === 0) {
                        progressElement.classList.add('not-started');
                        badgeElement.textContent = 'Not Started';
                        badgeElement.className = 'audio-completion-badge';
                    } else if (score.completed === score.total) {
                        progressElement.classList.add('perfect');
                        badgeElement.textContent = 'Perfect!';
                        badgeElement.className = 'audio-completion-badge perfect show';
                    } else {
                        progressElement.classList.add('completed');
                        badgeElement.textContent = `${score.completed}/${score.total}`;
                        badgeElement.className = 'audio-completion-badge show';
                    }
                }
            });
        }

        // Carousel functions
        function updateCarousel() {
            const carousel = document.getElementById('audio-carousel');
            const cards = carousel.querySelectorAll('.audio-card');
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Remove center class from all cards
            cards.forEach(card => card.classList.remove('center'));
            indicators.forEach(indicator => indicator.classList.remove('active'));
            
            // Add center class to current card
            cards[currentCarouselIndex].classList.add('center');
            indicators[currentCarouselIndex].classList.add('active');
            
            // Update selected audio type
            selectedAudioType = audioTypes[currentCarouselIndex];
            
            // Transform carousel
            const offset = -currentCarouselIndex * (350 + 32); // card width + gap
            carousel.style.transform = `translateX(calc(50% - 175px + ${offset}px))`;
            
            // Update button states
            document.getElementById('prev-btn').disabled = currentCarouselIndex === 0;
            document.getElementById('next-btn').disabled = currentCarouselIndex === audioTypes.length - 1;
        }

        function nextAudio() {
            if (currentCarouselIndex < audioTypes.length - 1) {
                currentCarouselIndex++;
                updateCarousel();
            }
        }

        function previousAudio() {
            if (currentCarouselIndex > 0) {
                currentCarouselIndex--;
                updateCarousel();
            }
        }

        // Modal functions
        function openAudioModal() {
            const audioInfo = getAudioInfo(selectedAudioType);
            const currentScore = progressiveScores[selectedAudioType];
            
            document.getElementById('modal-audio-title').textContent = audioInfo.title;
            document.getElementById('modal-audio-description').textContent = audioInfo.description;
            
            // Update modal score display
            const modalScoreElement = document.getElementById('modal-score');
            if (currentScore.completed === 0) {
                modalScoreElement.textContent = 'Not Started';
                modalScoreElement.style.color = '#999';
            } else {
                modalScoreElement.textContent = `${currentScore.completed}/${currentScore.total} completed`;
                if (currentScore.completed === currentScore.total) {
                    modalScoreElement.style.color = '#f39c12';
                } else {
                    modalScoreElement.style.color = '#00a86b';
                }
            }
            
            document.getElementById('audio-selection-modal').classList.add('show');
        }

        function closeAudioModal() {
            document.getElementById('audio-selection-modal').classList.remove('show');
        }

        function startGameFromModal() {
            closeAudioModal();
            startGame();
        }

        function getAudioInfo(audioType) {
            const audioData = {
                advice: {
                    title: 'B2 Advice for Exams',
                    description: 'Learn valuable study tips and exam strategies from experienced students and teachers.',
                    file: '../data/audio/B1_Advice_for_exams.mp3',
                    image: '../data/img/Advice_for_exams.jpg',
                    transcript: `Sarah: Hi Mark! I heard you aced your final exams last semester. Do you have any advice for someone who's really nervous about upcoming tests?

Mark: Oh, thanks Sarah! Yeah, I was pretty stressed at first too. But I found that starting early really makes a huge difference. Don't wait until the last week to begin studying.

Sarah: That makes sense. How early do you think I should start?

Mark: I'd say at least three weeks before your first exam. That gives you time to review everything properly and not feel rushed. Also, make a study schedule and stick to it.

Sarah: A schedule sounds good. What about the actual studying methods? I usually just read my notes over and over, but it doesn't seem to help much.

Mark: Reading is passive. Try active learning instead. Make flashcards, explain concepts out loud to yourself, or teach the material to a friend. When you have to explain something, you really understand if you know it or not.

Sarah: That's really helpful! I never thought about teaching others. Any other tips?

Mark: Definitely take care of your health. Get enough sleep, eat well, and take short breaks while studying. Your brain needs rest to process information properly. And don't forget to stay hydrated!

Sarah: Thanks Mark! This is all really useful advice. I feel much more confident about my exams now.`
                },
                llamas: {
                    title: 'B2 Llamas',
                    description: 'Discover fascinating facts about llamas and their role in South American culture.',
                    file: '../data/audio/B1_llamas.mp3',
                    image: '../data/img/llamas.png',
                    transcript: `Welcome to our nature documentary about llamas, one of South America's most fascinating animals.

Llamas are domesticated animals that originally come from the high mountains of South America, particularly in countries like Peru, Bolivia, and Ecuador. They belong to the camel family, but unlike their desert cousins, llamas are perfectly adapted to life in the high altitudes of the Andes Mountains.

For thousands of years, the indigenous people of South America have used llamas for many purposes. These gentle animals are excellent for carrying heavy loads across mountain paths where vehicles cannot go. A single llama can carry up to 30 kilograms of supplies, making them invaluable pack animals for mountain communities.

Llamas are also valued for their soft, warm wool. Their thick coats protect them from the cold mountain weather, and people use this wool to make clothing, blankets, and other textiles. Llama wool is known for being lightweight yet very warm.

One interesting thing about llamas is how they communicate. They make soft humming sounds to talk to each other, and they use body language extensively. When they're angry or feel threatened, llamas are famous for spitting! This might seem funny, but it's actually an effective way for them to defend themselves.

Today, llamas are not only working animals but also popular in many countries around the world for their gentle nature and unique appearance.`
                },
                weekend: {
                    title: 'B2 The Weekend',
                    description: 'Join a conversation about weekend plans, activities, and memorable experiences.',
                    file: '../data/audio/B1_the_weekend.mp3',
                    image: '../data/img/the_weekend.jpg',
                    transcript: `Emma: Hey Jake! It's Friday afternoon - do you have any exciting plans for the weekend?

Jake: Hi Emma! Yeah, I'm really looking forward to it. Tomorrow morning I'm going hiking with some friends in the national park. The weather forecast looks perfect for it. What about you?

Emma: That sounds amazing! I love hiking, but this weekend I'm planning something more relaxed. I'm meeting my sister for brunch tomorrow, and then we're going shopping for her birthday present.

Jake: Nice! When's her birthday?

Emma: Next Thursday. I want to find something special for her. She's been working so hard lately, so I think she deserves a really nice gift. Maybe some jewelry or a spa day voucher.

Jake: That's so thoughtful of you! I bet she'll love whatever you choose. Are you doing anything on Sunday?

Emma: Well, Sunday is my catch-up day. I need to do laundry, clean the apartment, and prepare for the busy week ahead. I know it sounds boring, but I actually enjoy having a quiet day at home sometimes. Plus, I want to try cooking that new pasta recipe I found online.

Jake: That doesn't sound boring at all! Sometimes the best weekends are the ones where you can just relax and take care of yourself. After our hike tomorrow, I'm planning to have a movie marathon at home on Sunday.

Emma: Perfect! Well, I hope you have a wonderful hike and enjoy your movies. See you Monday!

Jake: Thanks Emma! Have a great weekend with your sister!`
                }
            };
            return audioData[audioType];
        }

        // Game variables
        let currentQuestion = 0;
        let currentAudioScore = 0; // Score for current audio being played
        let totalQuestions = 5;
        let gameQuestions = [];
        let userAnswers = [];

        // Sample questions for each audio type
        const questionsData = {
            advice: [
                {
                    question: "What is the main topic of this audio?",
                    options: ["Travel tips", "Exam advice", "Cooking recipes", "Sports training"],
                    correct: 1
                },
                {
                    question: "According to Mark, when should students start studying for exams?",
                    options: ["The night before", "At least three weeks before", "One week before", "The morning of the exam"],
                    correct: 1
                },
                {
                    question: "What study technique does Mark recommend instead of just reading notes?",
                    options: ["Memorizing everything", "Active learning methods", "Passive reading only", "Group study always"],
                    correct: 1
                },
                {
                    question: "What does Mark say about taking care of health during exam preparation?",
                    options: ["It's not important", "Sleep and nutrition matter", "Only exercise matters", "Just drink coffee"],
                    correct: 1
                },
                {
                    question: "How does Sarah feel at the end of the conversation?",
                    options: ["More worried", "More confident", "Confused", "Angry"],
                    correct: 1
                }
            ],
            llamas: [
                {
                    question: "Where are llamas originally from?",
                    options: ["North America", "Europe", "South America", "Asia"],
                    correct: 2
                },
                {
                    question: "What family do llamas belong to?",
                    options: ["Horse family", "Camel family", "Sheep family", "Cow family"],
                    correct: 1
                },
                {
                    question: "How much weight can a llama carry?",
                    options: ["Up to 15 kg", "Up to 30 kg", "Up to 50 kg", "Up to 100 kg"],
                    correct: 1
                },
                {
                    question: "How do llamas primarily communicate with each other?",
                    options: ["Only barking", "Humming and body language", "Silent gestures only", "Roaring"],
                    correct: 1
                },
                {
                    question: "What do llamas do when they feel threatened?",
                    options: ["Run away only", "Spit", "Hide underground", "Play dead"],
                    correct: 1
                }
            ],
            weekend: [
                {
                    question: "What day of the week is this conversation taking place?",
                    options: ["Monday", "Friday", "Saturday", "Sunday"],
                    correct: 1
                },
                {
                    question: "What is Jake planning to do on Saturday morning?",
                    options: ["Go shopping", "Go hiking", "Stay home", "Visit family"],
                    correct: 1
                },
                {
                    question: "Why is Emma shopping for a birthday present?",
                    options: ["For her mother", "For her sister", "For Jake", "For herself"],
                    correct: 1
                },
                {
                    question: "What does Emma plan to do on Sunday?",
                    options: ["Go hiking", "Meet friends", "Household tasks and cooking", "Go to the movies"],
                    correct: 2
                },
                {
                    question: "What is Jake's Sunday plan?",
                    options: ["More hiking", "Movie marathon at home", "Shopping", "Visiting Emma"],
                    correct: 1
                }
            ]
        };

        // Navigation functions
        function showTutorial() {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('tutorial-screen').classList.add('active');
        }

        function showRules() {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('rules-screen').classList.add('active');
        }

        function showAudioSelection() {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('audio-selection-screen').classList.add('active');
            updateCarousel(); // Initialize carousel
            updateProgressDisplay(); // Update progress display
        }

        function backToAudioSelection() {
            // Reset current audio game state
            currentQuestion = 0;
            currentAudioScore = 0;
            userAnswers = [];
            
            // Stop and cleanup audio
            stopAndCleanupAudio();
            
            showAudioSelection();
        }

        function stopAndCleanupAudio() {
            // Stop all audio and reset
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
            }

            if (gameAudio) {
                gameAudio.pause();
                gameAudio.currentTime = 0;
            }

            // Reset audio player UI
            document.getElementById('play-btn').style.display = 'block';
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('audio-progress-fill').style.width = '0%';
            document.getElementById('current-time').textContent = '0:00';
            document.getElementById('total-time').textContent = '0:00';
        }

        function skipTutorial() {
            showRules();
        }

        // Tutorial navigation
        let currentTutorialStep = 1;
        const totalTutorialSteps = 5;

        function nextTutorial() {
            if (currentTutorialStep < totalTutorialSteps) {
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.remove('active');
                currentTutorialStep++;
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.add('active');
                updateTutorialDots();
            }
        }

        function prevTutorial() {
            if (currentTutorialStep > 1) {
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.remove('active');
                currentTutorialStep--;
                document.querySelector(`[data-step="${currentTutorialStep}"]`).classList.add('active');
                updateTutorialDots();
            }
        }

        function updateTutorialDots() {
            document.querySelectorAll('.tutorial-step.active .dot').forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 === currentTutorialStep);
            });
        }

        // Game functions
        function startGame() {
            // Initialize game for current audio
            currentQuestion = 0;
            currentAudioScore = 0;
            userAnswers = [];
            gameQuestions = questionsData[selectedAudioType];

            // Set up game audio
            const audioInfo = getAudioInfo(selectedAudioType);
            gameAudio.src = audioInfo.file;
            currentAudio = gameAudio;

            // Show game screen
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('game-screen').classList.add('active');

            // Load first question
            loadQuestion();
            
            // Set up audio player
            setupAudioPlayer();
        }

        function setupAudioPlayer() {
            const playBtn = document.getElementById('play-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const restartBtn = document.getElementById('restart-btn');
            const progressBar = document.getElementById('audio-progress-bar');
            const progressFill = document.getElementById('audio-progress-fill');
            const currentTimeSpan = document.getElementById('current-time');
            const totalTimeSpan = document.getElementById('total-time');

            // Remove existing event listeners to prevent duplicates
            playBtn.replaceWith(playBtn.cloneNode(true));
            pauseBtn.replaceWith(pauseBtn.cloneNode(true));
            restartBtn.replaceWith(restartBtn.cloneNode(true));

            // Get fresh references
            const newPlayBtn = document.getElementById('play-btn');
            const newPauseBtn = document.getElementById('pause-btn');
            const newRestartBtn = document.getElementById('restart-btn');

            newPlayBtn.addEventListener('click', () => {
                if (currentAudio && typeof currentAudio.play === 'function') {
                    currentAudio.play();
                    newPlayBtn.style.display = 'none';
                    newPauseBtn.style.display = 'block';
                }
            });

            newPauseBtn.addEventListener('click', () => {
                if (currentAudio && typeof currentAudio.pause === 'function') {
                    currentAudio.pause();
                    newPauseBtn.style.display = 'none';
                    newPlayBtn.style.display = 'block';
                }
            });

            newRestartBtn.addEventListener('click', () => {
                if (currentAudio && typeof currentAudio.currentTime === 'number') {
                    currentAudio.currentTime = 0;
                    if (currentAudio.paused) {
                        newPlayBtn.style.display = 'block';
                        newPauseBtn.style.display = 'none';
                    }
                }
            });

            // Enhanced progress bar functionality - allows clicking to seek
            progressBar.addEventListener('click', (e) => {
                if (currentAudio && typeof currentAudio.duration === 'number' && !isNaN(currentAudio.duration)) {
                    const rect = progressBar.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const percentage = clickX / width;
                    currentAudio.currentTime = currentAudio.duration * percentage;
                }
            });

            // Keyboard navigation for progress bar
            progressBar.addEventListener('keydown', (e) => {
                if (currentAudio && typeof currentAudio.duration === 'number' && !isNaN(currentAudio.duration)) {
                    const jumpTime = currentAudio.duration * 0.05; // 5% jumps
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        currentAudio.currentTime = Math.max(0, currentAudio.currentTime - jumpTime);
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        currentAudio.currentTime = Math.min(currentAudio.duration, currentAudio.currentTime + jumpTime);
                    }
                }
            });

            if (currentAudio) {
                currentAudio.addEventListener('loadedmetadata', function() {
                    if (typeof this.duration === 'number' && !isNaN(this.duration)) {
                        totalTimeSpan.textContent = formatTime(this.duration);
                    } else {
                        totalTimeSpan.textContent = '0:00';
                    }
                });

                currentAudio.addEventListener('timeupdate', function() {
                    // 'this' es el audio que dispara el evento
                    if (!this) return;
                    if (typeof this.duration === 'number' && !isNaN(this.duration) && typeof this.currentTime === 'number') {
                        const progress = (this.currentTime / this.duration) * 100;
                        progressFill.style.width = `${progress}%`;
                        currentTimeSpan.textContent = formatTime(this.currentTime);
                        // Update ARIA attributes for accessibility
                        progressBar.setAttribute('aria-valuenow', Math.round(progress));
                        progressBar.setAttribute('aria-valuetext', `${formatTime(this.currentTime)} of ${formatTime(this.duration)}`);
                    } else {
                        progressFill.style.width = '0%';
                        currentTimeSpan.textContent = '0:00';
                    }
                });

                currentAudio.addEventListener('ended', function() {
                    newPlayBtn.style.display = 'block';
                    newPauseBtn.style.display = 'none';
                });
                // Al cargar el audio, mostrar el estado correcto de los botones
                if (currentAudio.paused) {
                    newPlayBtn.style.display = 'block';
                    newPauseBtn.style.display = 'none';
                } else {
                    newPlayBtn.style.display = 'none';
                    newPauseBtn.style.display = 'block';
                }
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function loadQuestion() {
            const question = gameQuestions[currentQuestion];
            
            // Hide answer required message
            document.getElementById('answer-required-message').classList.remove('show');
            
            // Clear previous option selections and styles
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Update UI
            document.getElementById('current-story').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('story-title').textContent = getAudioInfo(selectedAudioType).title;
            document.getElementById('question-text').textContent = question.question;
            
            // Update progress for current audio
            const progress = (currentQuestion / totalQuestions) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            
            // Update overall progress display
            updateProgressDisplay();
            
            // Load options
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.innerHTML = `
                    <input type="radio" name="answer" id="option-${index}" value="${index}">
                    <label for="option-${index}">${option}</label>
                `;
                
                // Add click handler for visual feedback
                optionDiv.addEventListener('click', () => {
                    document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    optionDiv.classList.add('selected');
                    document.getElementById(`option-${index}`).checked = true;
                });
                
                optionsContainer.appendChild(optionDiv);
            });
            
            // Show question section, hide feedback
            document.getElementById('question-section').style.display = 'block';
            document.getElementById('feedback-section').style.display = 'none';
            
            // Reset submit button
            document.getElementById('submit-btn').disabled = false;
        }

        function submitAnswer() {
            const selectedOption = document.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                // Show answer required message with enhanced animation
                const messageElement = document.getElementById('answer-required-message');
                messageElement.classList.add('show');
                
                // Add shake animation to the entire question section
                const questionSection = document.getElementById('question-section');
                questionSection.style.animation = 'none';
                setTimeout(() => {
                    questionSection.style.animation = 'shake 0.5s ease-in-out';
                }, 10);
                
                // Hide message after 3 seconds
                setTimeout(() => {
                    messageElement.classList.remove('show');
                    questionSection.style.animation = 'none';
                }, 3000);
                
                return;
            }

            const userAnswer = parseInt(selectedOption.value);
            const correctAnswer = gameQuestions[currentQuestion].correct;
            const isCorrect = userAnswer === correctAnswer;
            
            // Store answer
            userAnswers.push({
                question: currentQuestion,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });
            
            // Update current audio score
            if (isCorrect) {
                currentAudioScore++;
            }
            
            // Add visual feedback to options
            document.querySelectorAll('.option').forEach((option, index) => {
                if (index === correctAnswer) {
                    option.classList.add('correct');
                } else if (index === userAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });
            
            // Disable submit button to prevent double submission
            document.getElementById('submit-btn').disabled = true;
            
            // Show feedback after a brief delay to let animations play
            setTimeout(() => {
                showFeedback(isCorrect, correctAnswer);
            }, 1000);
        }

        function showFeedback(isCorrect, correctAnswer) {
            const feedbackContent = document.getElementById('feedback-content');
            const question = gameQuestions[currentQuestion];
            const currentOverallProgress = calculateOverallProgress();
            
            feedbackContent.innerHTML = `
                <div class="feedback-result ${isCorrect ? 'correct' : 'incorrect'}">
                    <div class="feedback-icon">${isCorrect ? '‚úÖ' : '‚ùå'}</div>
                    <div class="feedback-text">
                        <h3>${isCorrect ? 'Excellent!' : 'Not quite right'}</h3>
                        <p>The correct answer is: <strong>${question.options[correctAnswer]}</strong></p>
                        ${isCorrect ? '<p>Great listening skills! Keep it up!</p>' : '<p>Don\'t worry, practice makes perfect!</p>'}
                    </div>
                </div>
                <div class="score-update">
                    Current Audio: ${currentAudioScore}/${totalQuestions} | Overall Progress: ${currentOverallProgress}%
                </div>
            `;
            
            // Update next button text
            const nextBtn = document.getElementById('next-btn');
            if (currentQuestion === totalQuestions - 1) {
                nextBtn.textContent = '‚Üí';
                nextBtn.style.background = '#FFFFFF';
            } else {
                nextBtn.textContent = 'Next Question ‚Üí';
                nextBtn.style.background = '#00a86b';
            }
            
            // Hide question, show feedback
            document.getElementById('question-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'block';
        }

        function nextStory() {
            currentQuestion++;
            
            if (currentQuestion >= totalQuestions) {
                // Save progress for this audio
                progressiveScores[selectedAudioType].completed = currentAudioScore;
                saveProgressiveScores();
                
                // Stop audio before showing results
                stopAndCleanupAudio();
                showResults();
            } else {
                loadQuestion();
            }
        }

        function showResults() {
            // Calculate scores
            const audioScorePercent = Math.round((currentAudioScore / totalQuestions) * 100);
            const overallProgress = calculateOverallProgress();

            // Update final stats display
            document.getElementById('final-audio-score').textContent = `${audioScorePercent}%`;
            document.getElementById('final-overall-score').textContent = `${overallProgress}%`;
            document.getElementById('final-correct').textContent = `${currentAudioScore}/${totalQuestions}`;

            // Debug: Mostrar estado de autenticaci√≥n
            let debugDiv = document.getElementById('debug-firestore-status');
            if (!debugDiv) {
                debugDiv = document.createElement('div');
                debugDiv.id = 'debug-firestore-status';
                debugDiv.style = 'background: #222; color: #fff; padding: 8px; font-size: 1rem; position: fixed; bottom: 0; left: 0; z-index: 9999;';
                document.body.appendChild(debugDiv);
            }

            // Mostrar estado de autenticaci√≥n
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        debugDiv.textContent = 'Usuario autenticado: ' + user.email;
                        // Intentar guardar score en Firestore
                        saveListeningGameScoreToFirestore(user.uid, selectedAudioType, currentAudioScore, function(success, error) {
                            if (success) {
                                debugDiv.textContent += ' | Score guardado correctamente en Firestore.';
                                console.log('Score guardado correctamente en Firestore.');
                            } else {
                                debugDiv.textContent += ' | Error al guardar score: ' + error;
                                console.error('Error al guardar score en Firestore:', error);
                            }
                        });
                    } else {
                        debugDiv.textContent = 'Usuario no autenticado.';
                        console.warn('Usuario no autenticado.');
                    }
                });
            } else {
                debugDiv.textContent = 'Firebase no est√° cargado.';
                console.error('Firebase no est√° cargado.');
            }

            // ...existing code for results UI...
            // Generate audio results grid
            const audioResultsGrid = document.getElementById('audio-results-grid');
            audioResultsGrid.innerHTML = '';
            audioTypes.forEach(audioType => {
                const audioInfo = getAudioInfo(audioType);
                const score = progressiveScores[audioType];
                const audioResultCard = document.createElement('div');
                let cardClass = 'audio-result-card';
                let scoreClass = 'audio-result-score';
                let scoreText = 'Not Started';
                if (score.completed > 0) {
                    cardClass += ' completed';
                    scoreClass += ' completed';
                    scoreText = `${score.completed}/${score.total}`;
                    if (score.completed === score.total) {
                        cardClass = 'audio-result-card perfect';
                        scoreClass = 'audio-result-score perfect';
                    }
                } else {
                    scoreClass += ' not-started';
                }
                audioResultCard.className = cardClass;
                audioResultCard.innerHTML = `
                    <div class="audio-result-title">${audioInfo.title}</div>
                    <div class="${scoreClass}">${scoreText}</div>
                `;
                audioResultsGrid.appendChild(audioResultCard);
            });

            // Generate encouragement message
            const encouragementElement = document.getElementById('progress-encouragement');
            const totalCompleted = Object.values(progressiveScores).reduce((sum, audio) => sum + audio.completed, 0);
            let encouragementMessage = '';
            if (overallProgress === 100) {
                encouragementMessage = 'üéâ Congratulations! You\'ve mastered all audio stories with 100% completion!';
            } else if (overallProgress >= 80) {
                encouragementMessage = 'üåü Amazing progress! You\'re very close to mastering all audio stories!';
            } else if (overallProgress >= 60) {
                encouragementMessage = 'üí™ Great work! You\'re more than halfway to completing all audio stories!';
            } else if (overallProgress >= 40) {
                encouragementMessage = 'üöÄ Good progress! Keep going to unlock more audio stories!';
            } else if (overallProgress > 0) {
                encouragementMessage = 'üå± Nice start! Try the other audio stories to build your progress!';
            } else {
                encouragementMessage = 'üéØ This was your first audio! Try the others to build your overall score!';
            }
            encouragementElement.innerHTML = `<p style="text-align: center; font-size: 1.1rem; color: #00a86b; font-weight: 600;">${encouragementMessage}</p>`;

            // Generate performance list for current audio
            const performanceList = document.getElementById('performance-list');
            performanceList.innerHTML = '';
            userAnswers.forEach((answer, index) => {
                const question = gameQuestions[answer.question];
                const performanceItem = document.createElement('div');
                performanceItem.className = `performance-item ${answer.isCorrect ? 'correct' : 'incorrect'}`;
                performanceItem.innerHTML = `
                    <div class="performance-icon">${answer.isCorrect ? '‚úÖ' : '‚ùå'}</div>
                    <div class="performance-details">
                        <div class="performance-question">Question ${index + 1}: ${question.question.substring(0, 50)}...</div>
                        <div class="performance-result">${answer.isCorrect ? 'Correct' : 'Incorrect'} - ${question.options[answer.correctAnswer]}</div>
                    </div>
                `;
                performanceList.appendChild(performanceItem);
            });

            // Show complete screen
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById('complete-screen').classList.add('active');
        }

        // Funci√≥n para guardar el score en Firestore y mostrar logs
        function saveListeningGameScoreToFirestore(uid, audioType, score, callback) {
            try {
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    callback(false, 'Firebase Firestore no est√° disponible');
                    return;
                }
                const db = firebase.firestore();
                // Sumar los puntajes de los 3 audios
                const totalScore =
                    (progressiveScores.advice.completed || 0) +
                    (progressiveScores.llamas.completed || 0) +
                    (progressiveScores.weekend.completed || 0);
                // Regla de 3 para porcentaje
                const percentScore = Math.round((totalScore / 15) * 100);
                db.collection('user').doc(uid).set({
                    game1_score: percentScore,
                    updatedAt: new Date()
                }, { merge: true })
                .then(() => {
                    callback(true);
                })
                .catch((error) => {
                    callback(false, error.message || error);
                });
            } catch (err) {
                callback(false, err.message || err);
            }
        }

        function retryCurrentAudio() {
            // Reset current audio progress but keep overall progress
            currentQuestion = 0;
            currentAudioScore = 0;
            userAnswers = [];
            
            // Start the same audio again
            startGame();
        }

        function playAgain() {
            // Reset carousel to first item
            currentCarouselIndex = 0;
            selectedAudioType = 'advice';
            
            // Reset current game variables
            currentQuestion = 0;
            currentAudioScore = 0;
            userAnswers = [];
            
            // Stop and cleanup audio
            stopAndCleanupAudio();
            
            // Hide any modals or overlays that might be showing
            closeAudioModal();
            document.getElementById('transcript-modal').style.display = 'none';
            
            // Show audio selection screen
            showAudioSelection();
            
            // Force carousel update to fix arrow states
            setTimeout(() => {
                updateCarousel();
                
                // Additional cleanup for carousel display
                const carousel = document.getElementById('audio-carousel');
                const cards = carousel.querySelectorAll('.audio-card');
                
                // Ensure only audio cards are visible and properly positioned
                cards.forEach((card, index) => {
                    card.style.display = 'block';
                    card.classList.remove('center');
                    if (index === 0) {
                        card.classList.add('center');
                    }
                });
            }, 100);
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        // Transcript functionality
        function closeTranscript() {
            document.getElementById('transcript-modal').style.display = 'none';
        }

        document.getElementById('transcript-btn').addEventListener('click', () => {
            loadTranscript();
            document.getElementById('transcript-modal').style.display = 'flex';
        });

        function loadTranscript() {
            const transcriptText = document.getElementById('transcript-text');
            
            if (selectedAudioType) {
                const audioInfo = getAudioInfo(selectedAudioType);
                transcriptText.innerHTML = `<div style="line-height: 1.8; font-size: 1rem; color: #333;">${audioInfo.transcript.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</div>`;
            } else {
                transcriptText.textContent = 'Transcript not available.';
            }
        }

        // Speed control
        let currentSpeed = 1;
        const speeds = [0.5, 0.75, 1, 1.25, 1.5];

        document.getElementById('speed-btn').addEventListener('click', () => {
            const currentIndex = speeds.indexOf(currentSpeed);
            currentSpeed = speeds[(currentIndex + 1) % speeds.length];
            if (currentAudio) {
                currentAudio.playbackRate = currentSpeed;
            }
            document.getElementById('speed-btn').textContent = `Speed: ${currentSpeed}x`;
        });

        // Volume control
        document.getElementById('volume-btn').addEventListener('click', () => {
            if (currentAudio) {
                currentAudio.muted = !currentAudio.muted;
                document.getElementById('volume-btn').textContent = currentAudio.muted ? 'üîá' : 'üîä';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Only handle shortcuts when in game screen
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            
            switch(e.key) {
                case ' ': // Spacebar to play/pause
                    e.preventDefault();
                    if (currentAudio && currentAudio.paused) {
                        document.getElementById('play-btn').click();
                    } else {
                        document.getElementById('pause-btn').click();
                    }
                    break;
                case 'r': // R to restart
                    e.preventDefault();
                    document.getElementById('restart-btn').click();
                    break;
                case 't': // T to toggle transcript
                    e.preventDefault();
                    document.getElementById('transcript-btn').click();
                    break;
                case 's': // S to change speed
                    e.preventDefault();
                    document.getElementById('speed-btn').click();
                    break;
            }
        });

        // Initialize image loading
        function loadAudioImages() {
            const audioCards = document.querySelectorAll('.audio-card-image');
            audioCards.forEach(card => {
                const audioType = card.parentElement.dataset.audio;
                const audioInfo = getAudioInfo(audioType);
                
                // Try to load the image, fallback to gradient if not found
                const img = new Image();
                img.onload = () => {
                    card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${audioInfo.image}')`;
                };
                img.onerror = () => {
                    // Keep the current gradient background
                    console.log(`Image not found: ${audioInfo.image}`);
                };
                img.src = audioInfo.image;
            });
        }

        // Initialize carousel indicators
        document.querySelectorAll('.carousel-indicator').forEach((indicator, index) => {
            indicator.addEventListener('click', () => {
                currentCarouselIndex = index;
                updateCarousel();
            });
        });

        // Enhanced close transcript functionality
        document.getElementById('transcript-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('transcript-modal')) {
                closeTranscript();
            }
        });

        // Close transcript with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('transcript-modal').style.display === 'flex') {
                closeTranscript();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved progress
            loadProgressiveScores();
            
            // Show tutorial by default
            document.getElementById('tutorial-screen').classList.add('active');
            
            // Initialize carousel
            updateCarousel();
            
            // Update progress display
            updateProgressDisplay();
            
            // Load images
            loadAudioImages();
            
            // Close modal when clicking outside
            document.getElementById('audio-selection-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('audio-selection-modal')) {
                    closeAudioModal();
                }
            });

            // Add hover effect for transcript close button
            const closeBtn = document.querySelector('.close-transcript');
            if (closeBtn) {
                closeBtn.addEventListener('mouseenter', () => {
                    closeBtn.style.background = 'rgba(255,255,255,0.2)';
                });
                closeBtn.addEventListener('mouseleave', () => {
                    closeBtn.style.background = 'none';
                });
            }
        });
    </script>
</body>
</html>